<div class="page-background">
  <div class="usuarios-container">
    <div class="container-header">
      <div class="header-title-group">
        <h2>Gestión de Usuarios</h2>
        <p>Administra el acceso y roles del personal</p>
      </div>
      
      <div class="acciones-header" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
          
          <div class="filtro-estado-group">
              <button class="btn-filtro" [class.active]="filtroEstado === 'Todos'" (click)="cambiarFiltroEstado('Todos')">Todos</button>
              <button class="btn-filtro" [class.active]="filtroEstado === 'Activo'" (click)="cambiarFiltroEstado('Activo')">Activos</button>
              <button class="btn-filtro" [class.active]="filtroEstado === 'Inactivo'" (click)="cambiarFiltroEstado('Inactivo')">Inactivos</button>
          </div>

          <div class="search-wrapper">
             <i class="fas fa-search search-icon"></i>
             <input type="text" 
                    class="search-input" 
                    placeholder="Buscar..." 
                    [(ngModel)]="terminoBusqueda" 
                    (keyup)="filtrarUsuarios()">
          </div>

          <button class="btn-agregar" (click)="abrirModal()" *ngIf="authService.hasRole(['Admin', 'SuperUsuario'])">
            <span>&#43;</span> Nuevo
          </button>
      </div>
    </div>

    <div class="container-body">
      <div class="tabla-responsive-wrapper">
        <table class="tabla-usuarios">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Usuario</th>
              <th>Puesto</th>
              <th>Rol</th>
              <th>Estado</th>
              <th style="text-align: center;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let usuario of usuariosFiltrados" (click)="verCredencial(usuario)" style="cursor: pointer;" title="Clic para ver credencial">
              <td>
                  <div class="user-info-cell">
                      <img [src]="'https://ui-avatars.com/api/?name=' + usuario.nombre + '&background=random&color=fff&size=40'" 
                           class="user-avatar" 
                           alt="Avatar">
                      <div class="user-details">
                          <span class="user-name">{{ usuario.nombre }}</span>
                          <span class="user-email">{{ usuario.departamento || 'Sin departamento' }}</span>
                      </div>
                  </div>
              </td>
              <td>{{ usuario.nombre_usuario }}</td>
              <td>{{ usuario.puesto }}</td>
              <td>
                <span class="rol-badge" [ngClass]="{
                  'admin': usuario.rol === 'Admin',
                  'superusuario': usuario.rol === 'SuperUsuario',
                  'usuario': usuario.rol === 'Usuario'
                }">
                  {{ usuario.rol }}
                </span>
              </td>
              <td>
                <span [class.estado-activo]="usuario.estado_cuenta === 'Activo'"
                      [class.estado-inactivo]="usuario.estado_cuenta === 'Inactivo'">
                  {{ usuario.estado_cuenta }}
                </span>
              </td>
              <td class="acciones" (click)="$event.stopPropagation()"> <ng-container *ngIf="authService.hasRole(['Admin', 'SuperUsuario'])">
                  <button class="btn-accion btn-editar" (click)="abrirModalEditar(usuario)" title="Editar">
                      <i class="fas fa-pen"></i>
                  </button>
                  <button class="btn-accion btn-eliminar" (click)="abrirModalBorrado(usuario)" title="Desactivar">
                      <i class="fas fa-trash"></i>
                  </button>
                </ng-container>
              </td>
            </tr>
            <tr *ngIf="usuariosFiltrados.length === 0">
                <td colspan="6" style="text-align: center; padding: 30px; color: #aaa;">
                    No se encontraron usuarios que coincidan con la búsqueda.
                </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="pagination-container" *ngIf="usuariosFiltrados.length > 0">
          <span>Mostrando {{ usuariosFiltrados.length }} registros</span>
          </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModal" (click)="cerrarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ modoEdicion ? 'Editar Empleado' : 'Agregar Nuevo Empleado' }}</h3>
      <button class="btn-cerrar" (click)="cerrarModal()">×</button>
    </div>
    <div class="modal-body">
      <form (ngSubmit)="guardarEmpleado()">
        <div class="form-grid">
            <div class="form-group">
              <label for="nombre">Nombre Completo</label>
              <input id="nombre" type="text" class="form-control" [(ngModel)]="nuevoEmpleado.Nombre" name="Nombre" placeholder="Ej. Aldair Carrillo" required>
            </div>
            <div class="form-group">
              <label for="usuario">Nombre de Usuario</label>
              <input id="usuario" type="text" class="form-control" [(ngModel)]="nuevoEmpleado.Nombre_Usuario" name="Nombre_Usuario" placeholder="Ej. Aldo" required [disabled]="modoEdicion">
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
              <label for="puesto">Puesto</label>
              <input id="puesto" type="text" class="form-control" [(ngModel)]="nuevoEmpleado.Puesto" name="Puesto" placeholder="Ej. Almacenista">
            </div>
            <div class="form-group">
              <label for="departamento">Departamento</label>
              <input id="departamento" type="text" class="form-control" [(ngModel)]="nuevoEmpleado.Departamento" name="Departamento" placeholder="Ej. Almacén">
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
              <label for="rol">Rol del Usuario</label>
              <select id="rol" class="form-control" [(ngModel)]="nuevoEmpleado.ID_Rol" name="ID_Rol" required>
                <option [ngValue]="null" disabled>Selecciona un rol...</option>
                <option *ngFor="let rol of roles" [ngValue]="rol.id_rol">
                  {{ rol.nombre_rol }}
                </option>
              </select>
            </div>
            
            <div class="form-group" *ngIf="!modoEdicion">
              <label for="password">Contraseña</label>
              <input id="password" type="password" class="form-control" [(ngModel)]="nuevoEmpleado.Contrasena_Hash" name="Contrasena_Hash" placeholder="••••••••" required>
            </div>
        </div>

        <div class="form-group" *ngIf="modoEdicion">
            <label>Estado de la cuenta</label>
            <div class="switch-container">
                <span [style.color]="nuevoEmpleado.Estado_Cuenta === 'Activo' ? '#63d471' : '#aaa'">Activo</span>
                <label class="switch">
                    <input type="checkbox" 
                           [checked]="nuevoEmpleado.Estado_Cuenta === 'Activo'"
                           (change)="nuevoEmpleado.Estado_Cuenta = $event.target.checked ? 'Activo' : 'Inactivo'">
                    <span class="slider"></span>
                </label>
                <span [style.color]="nuevoEmpleado.Estado_Cuenta === 'Inactivo' ? '#ff6666' : '#aaa'">Inactivo</span>
            </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-cancelar" (click)="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn-guardar">{{ modoEdicion ? 'Actualizar' : 'Guardar' }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalBorrado" (click)="cerrarModalBorrado()">
  <div class="modal-content" (click)="$event.stopPropagation()" style="max-width: 450px;">
    <div class="modal-header header-eliminar">
      <h3>Confirmar Desactivación</h3>
      <button class="btn-cerrar" (click)="cerrarModalBorrado()">×</button>
    </div>
    <div class="modal-body">
      <p class="confirm-text" *ngIf="usuarioAEliminar">
        ¿Estás seguro de que deseas desactivar el acceso al usuario
        <strong>{{ usuarioAEliminar.nombre_usuario }}</strong>?
      </p>
      <p class="confirm-warning">El usuario no podrá iniciar sesión, pero sus datos se conservarán.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cancelar" (click)="cerrarModalBorrado()">Cancelar</button>
      <button type="button" class="btn-guardar btn-confirmar-eliminar" style="background: linear-gradient(135deg, #d9534f 0%, #c9302c 100%); border: none;" (click)="confirmarEliminacion()">Sí, Desactivar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalNotificacion" (click)="cerrarModalNotificacion()">
  <div class="modal-content" (click)="$event.stopPropagation()" style="max-width: 400px;">
    <div class="modal-header" [ngClass]="{
      'header-exito': notificacion.tipo === 'exito',
      'header-error': notificacion.tipo === 'error',
      'header-advertencia': notificacion.tipo === 'advertencia'
    }">
      <h3>{{ notificacion.titulo }}</h3>
      <button class="btn-cerrar" (click)="cerrarModalNotificacion()">×</button>
    </div>
    <div class="modal-body">
      <p class="confirm-text">{{ notificacion.mensaje }}</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-guardar" (click)="cerrarModalNotificacion()">Aceptar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="modalCredencialVisible" (click)="cerrarCredencial()">
    <div class="id-card-wrapper" (click)="$event.stopPropagation()">
      
      <div class="id-card-header">
        <div class="company-logo">
          <i class="fas fa-bus"></i> 
          <span>TRANSPORTE</span>
        </div>
        <div class="id-title">IDENTIFICACIÓN OFICIAL</div>
      </div>
  
      <div class="id-card-body">
        <div class="avatar-container">
          <img [src]="'https://ui-avatars.com/api/?name=' + (usuarioSeleccionado?.nombre || 'User') + '&background=4480d3&color=fff&size=128&bold=true'" 
               alt="Foto Empleado" class="avatar-img">
          <div class="estado-dot" [ngClass]="{'online': usuarioSeleccionado?.estado_cuenta === 'Activo'}"></div>
        </div>
  
        <div class="info-principal">
          <h2 class="nombre-empleado">{{ usuarioSeleccionado?.nombre }}</h2>
          <p class="puesto-empleado">{{ usuarioSeleccionado?.puesto | uppercase }}</p>
        </div>
  
        <div class="grid-detalles">
          <div class="detalle-item">
            <span class="label">Departamento</span>
            <span class="valor">{{ usuarioSeleccionado?.departamento || 'General' }}</span>
          </div>
          <div class="detalle-item">
            <span class="label">Usuario</span>
            <span class="valor">@{{ usuarioSeleccionado?.nombre_usuario }}</span>
          </div>
          <div class="detalle-item">
            <span class="label">Rol</span>
            <span class="valor">{{ usuarioSeleccionado?.rol || 'N/A' }}</span>
          </div>
          <div class="detalle-item">
            <span class="label">Estado</span>
            <span class="valor" [style.color]="usuarioSeleccionado?.estado_cuenta === 'Activo' ? '#63d471' : '#ff6666'">
                {{ usuarioSeleccionado?.estado_cuenta | uppercase }}
            </span>
          </div>
        </div>
      </div>
  
      <div class="id-card-footer">
        <div class="barcode">
          || ||| || ||||| || || | |||| ||
        </div>
        <p class="id-unique">ID: {{ usuarioSeleccionado?.id_empleado | number:'3.0-0' }}</p>
      </div>
  
      <button class="btn-close-card" (click)="cerrarCredencial()">×</button>
    </div>
  </div>