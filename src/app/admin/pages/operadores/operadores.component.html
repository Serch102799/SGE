<div class="usuarios-container">
  <div class="container-header">
    <h2>Catálogo de Operadores</h2>
    <button class="btn-agregar" (click)="abrirModal('agregar')" *ngIf="authService.hasRole(['Admin', 'SuperUsuario'])">
      <span>&#43;</span> Agregar Operador
    </button>
  </div>

  <div class="container-body">
    <div class="filtros-container">
      <div class="filtro-item" style="flex-grow: 3;">
        <input type="text" class="form-control" placeholder="Buscar por nombre, n° de empleado o NSS..."
          [(ngModel)]="terminoBusqueda" (ngModelChange)="onSearchChange()">
      </div>
      <div class="filtro-item" style="flex-grow: 1;">
        <label for="filtroEstado" class="form-label-simple">Estado:</label>
        <select id="filtroEstado" class="form-control" [(ngModel)]="filtroEstado" (change)="onFiltroChange()">
          <option value="activos">Activos</option>
          <option value="inactivos">Inactivos</option>
          <option value="todos">Todos</option>
        </select>
      </div>
    </div>

    <div class="contador-resultados">
      <strong>{{ totalItems }}</strong> operadores encontrados
    </div>

    <div class="tabla-responsive-wrapper">
      <table class="tabla-usuarios">
        <thead>
          <tr>
            <th>Nombre Completo</th>
            <th>N° Empleado</th>
            <th>Licencia</th>
            <th>NSS</th>
            <th>Edad</th>
            <th>Antigüedad</th>
            <th>Estatus</th> <th style="text-align: center;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let operador of operadores | paginate: { itemsPerPage: itemsPerPage, currentPage: currentPage, totalItems: totalItems }">
            <td>{{ operador.nombre_completo }}</td>
            <td>{{ operador.numero_empleado }}</td>
            <td>{{ operador.numero_licencia }} ({{ operador.tipo_licencia }})</td>
            <td>{{ operador.nss }}</td>
            <td>{{ operador.edad }} años</td>
            <td>{{ operador.antiguedad_anios }} años</td>
            <td>
              <span class="badge"
                [ngClass]="{'badge-activo': operador.esta_activo, 'badge-inactivo': !operador.esta_activo}">
                {{ operador.esta_activo ? 'Activo' : 'Inactivo' }}
              </span>
            </td>
            <td class="acciones" *ngIf="authService.hasRole(['Admin', 'SuperUsuario'])">
              <button class="btn-accion btn-estado" (click)="abrirModal('editar', operador)">Editar</button>
              
              <button class="btn-accion btn-eliminar" *ngIf="operador.esta_activo"
                (click)="abrirModalBaja(operador)">Desactivar</button>

              <button class="btn-accion btn-reactivar" *ngIf="!operador.esta_activo"
                (click)="reactivarOperador(operador)">Reactivar</button>
            </td>
          </tr>
          <tr *ngIf="operadores.length === 0">
            <td colspan="8" class="empty-table-message">No se encontraron operadores con los filtros aplicados.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination-controls">
      <pagination-controls (pageChange)="onPageChange($event)" previousLabel="Anterior"
        nextLabel="Siguiente"></pagination-controls>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModal" (click)="cerrarModal()">
  <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ modoEdicion ? 'Editar Operador' : 'Agregar Nuevo Operador' }}</h3>
      <button class="btn-cerrar" (click)="cerrarModal()">×</button>
    </div>
    <div class="modal-body">
      <form (ngSubmit)="guardarOperador()">
        <div class="form-row">
          <div class="form-group col-md-8"><label>Nombre Completo</label><input type="text" class="form-control"
              [(ngModel)]="operadorSeleccionado.nombre_completo" name="nombre_completo" required></div>
          <div class="form-group col-md-4"><label>N° de Empleado</label><input type="text" class="form-control"
              [(ngModel)]="operadorSeleccionado.numero_empleado" name="numero_empleado"></div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-4"><label>NSS (Seguro Social)</label><input type="text" class="form-control"
              [(ngModel)]="operadorSeleccionado.nss" name="nss"></div>
          <div class="form-group col-md-4"><label>Estatus NSS</label>
            <select class="form-control" [(ngModel)]="operadorSeleccionado.estatus_nss" name="estatus_nss">
              <option value="Activo">Activo</option>
              <option value="Inactivo">Inactivo</option>
              <option value="En trámite">En trámite</option>
            </select>
          </div>
        </div>
        <hr>
        <div class="form-row">
          <div class="form-group col-md-4"><label>N° de Licencia</label><input type="text" class="form-control"
              [(ngModel)]="operadorSeleccionado.numero_licencia" name="numero_licencia"></div>
          <div class="form-group col-md-4"><label>Tipo de Licencia</label><input type="text" class="form-control"
              [(ngModel)]="operadorSeleccionado.tipo_licencia" name="tipo_licencia"></div>
          <div class="form-group col-md-4"><label>Vencimiento de Licencia</label><input type="date" class="form-control"
              [(ngModel)]="operadorSeleccionado.licencia_vencimiento" name="licencia_vencimiento"></div>
        </div>
        <hr>
        <div class="form-row">
          <div class="form-group col-md-4"><label>Fecha de Nacimiento</label><input type="date" class="form-control"
              [(ngModel)]="operadorSeleccionado.fecha_nacimiento" name="fecha_nacimiento"></div>
          <div class="form-group col-md-4"><label>Fecha de Ingreso</label><input type="date" class="form-control"
              [(ngModel)]="operadorSeleccionado.fecha_ingreso" name="fecha_ingreso"></div>
          
          </div>
        <div class="modal-footer">
          <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn-accion btn-guardar">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalBaja" (click)="cerrarModalBaja()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header header-advertencia"> <h3>Desactivar Operador</h3>
      <button class="btn-cerrar" (click)="cerrarModalBaja()">×</button>
    </div>
    <div class="modal-body">
      <p class="confirm-text">¿Estás seguro de que deseas desactivar a <strong>{{ operadorParaBaja?.nombre_completo }}</strong>?</p>
      <p class="confirm-text">Por favor, proporciona los detalles de la baja:</p>
      
      <form (ngSubmit)="confirmarBaja()">
        <div class="form-group">
          <label for="fecha_baja">Fecha de Baja</label>
          <input type="date" id="fecha_baja" class="form-control" 
                 [(ngModel)]="datosBaja.fecha_baja" name="fecha_baja" required>
        </div>
        <div class="form-group">
          <label for="motivo_baja">Motivo de la Baja</label>
          <textarea id="motivo_baja" class="form-control" rows="3" 
                    [(ngModel)]="datosBaja.motivo_baja" name="motivo_baja" 
                    placeholder="Ej: Renuncia voluntaria, fin de contrato, etc." required></textarea>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModalBaja()">Cancelar</button>
          <button type="submit" class="btn-accion btn-eliminar">Confirmar Baja</button>
        </div>
      </form>
      
    </div>
  </div>
</div>
<div class="modal-overlay" *ngIf="mostrarModalReactivar" (click)="cerrarModalReactivar()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header header-advertencia">
      <h3>Confirmar Reactivación</h3>
      <button class="btn-cerrar" (click)="cerrarModalReactivar()">×</button>
    </div>
    <div class="modal-body">
      <p class="confirm-text">¿Estás seguro de que deseas reactivar a <strong>{{ operadorParaReactivar?.nombre_completo }}</strong>?</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModalReactivar()">Cancelar</button>
      <button type="button" class="btn-accion btn-guardar" (click)="confirmarReactivacion()">Confirmar</button>
    </div>
  </div>
</div>
<div class="modal-overlay" *ngIf="mostrarModalNotificacion" (click)="cerrarModalNotificacion()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header"
      [ngClass]="{'header-exito': notificacion.tipo === 'exito','header-error': notificacion.tipo === 'error','header-advertencia': notificacion.tipo === 'advertencia'}">
      <h3>{{ notificacion.titulo }}</h3>
      <button class="btn-cerrar" (click)="cerrarModalNotificacion()">×</button>
    </div>
    <div class="modal-body">
      <p class="confirm-text">{{ notificacion.mensaje }}</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-accion btn-guardar" (click)="cerrarModalNotificacion()">Aceptar</button>
    </div>
  </div>
</div>


