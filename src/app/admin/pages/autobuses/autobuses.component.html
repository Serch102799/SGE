<div class="usuarios-container">
  <div class="container-header">
    <h2>Gesti√≥n de Autobuses</h2>
    <button class="btn-agregar" (click)="abrirModal('agregar')" *ngIf="authService.hasRole(['Admin', 'SuperUsuario'])">
      <span>&#43;</span> Agregar Autob√∫s
    </button>
  </div>

  <div class="container-body">
    <div class="filtros-container">
      <div class="filtro-item">
        <input type="text" class="form-control" placeholder="Buscar por econ√≥mico, marca, VIN, placa o chasis..."
          [(ngModel)]="terminoBusqueda" (ngModelChange)="onSearchChange()">
      </div>
    </div>

    <div class="contador-resultados">
      <strong>{{ totalItems }}</strong> autobuses encontrados
    </div>

    <div class="tabla-responsive-wrapper">
      <table class="tabla-usuarios">
        <thead>
          <tr>
            <th>
              <button (click)="onSort('economico')">
                N¬∞ Econ√≥mico
                <span *ngIf="sortField === 'economico'">{{ sortDirection === 'asc' ? 'üîº' : 'üîΩ' }}</span>
              </button>
            </th>
            <th>
              <button (click)="onSort('razon_social')">
                Raz√≥n Social
                <span *ngIf="sortField === 'razon_social'">{{ sortDirection === 'asc' ? 'üîº' : 'üîΩ' }}</span>
              </button>
            </th>
            <th>
              <button (click)="onSort('placa')">
                Placa
                <span *ngIf="sortField === 'placa'">{{ sortDirection === 'asc' ? 'üîº' : 'üîΩ' }}</span>
              </button>
            </th>
            <th>
              <button (click)="onSort('marca')">
                Marca
                <span *ngIf="sortField === 'marca'">{{ sortDirection === 'asc' ? 'üîº' : 'üîΩ' }}</span>
              </button>
            </th>
            <th>
              <button (click)="onSort('modelo')">
                Modelo
                <span *ngIf="sortField === 'modelo'">{{ sortDirection === 'asc' ? 'üîº' : 'üîΩ' }}</span>
              </button>
            </th>
            <th>
              <button (click)="onSort('anio')">
                A√±o
                <span *ngIf="sortField === 'anio'">{{ sortDirection === 'asc' ? 'üîº' : 'üîΩ' }}</span>
              </button>
            </th>
            <th>
              <button (click)="onSort('kilometraje_actual')">
                Kilometraje
                <span *ngIf="sortField === 'kilometraje_actual'">{{ sortDirection === 'asc' ? 'üîº' : 'üîΩ' }}</span>
              </button>
            </th>
            <th style="text-align: center;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let autobus of autobuses | paginate: { itemsPerPage: itemsPerPage, currentPage: currentPage, totalItems: totalItems }"
            (click)="abrirModalDetalles(autobus)" class="fila-clickable">
            <td>{{ autobus.economico }}</td>
            <td>{{ autobus.razon_social }}</td>
            <td>{{ autobus.placa }}</td>
            <td>{{ autobus.marca }}</td>
            <td>{{ autobus.modelo }}</td>
            <td>{{ autobus.anio }}</td>
            <td>{{ autobus.kilometraje_actual | number }} km</td>
            <td class="acciones" *ngIf="authService.hasRole(['Admin', 'SuperUsuario'])"
              (click)="$event.stopPropagation()">
              <button class="btn-accion btn-historial" (click)="verHistorial(autobus)">Historial</button>
              <button class="btn-accion btn-estado" (click)="abrirModal('editar', autobus)">Editar</button>
              <button class="btn-accion btn-eliminar" (click)="abrirModalBorrar(autobus)">Eliminar</button>
              <button class="btn-accion btn-sync" (click)="abrirModalSyncKm(autobus)">Sincronizar KM</button>
            </td>
          </tr>
          <tr *ngIf="autobuses.length === 0">
            <td colspan="8" class="empty-table-message">No se encontraron autobuses que coincidan con la b√∫squeda.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination-controls">
      <pagination-controls (pageChange)="onPageChange($event)" previousLabel="Anterior" nextLabel="Siguiente"
        screenReaderPaginationLabel="Paginaci√≥n" screenReaderPageLabel="p√°gina"
        screenReaderCurrentLabel="Est√°s en la p√°gina">
      </pagination-controls>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModal" (click)="cerrarModal()">
  <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ modoEdicion ? 'Editar Autob√∫s' : 'Agregar Nuevo Autob√∫s' }}</h3>
      <button class="btn-cerrar" (click)="cerrarModal()">√ó</button>
    </div>
    <div class="modal-body">
      <form (ngSubmit)="guardarAutobus()">
        <div class="form-row">
          <div class="form-group col">
            <label>N¬∞ Econ√≥mico</label>
            <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.economico" name="economico"
              [disabled]="modoEdicion" required>
          </div>
          <div class="form-group col">
            <label>VIN (N√∫mero de Serie)</label>
            <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.vin" name="vin"
              [disabled]="modoEdicion" required minlength="17" maxlength="17">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col">
            <label>Placa</label>
            <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.placa" name="placa" required>
          </div>
          <div class="form-group col">
            <label>Modelo Chasis</label>
            <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.chasis" name="chasis">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col">
            <label>Motor</label>
            <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.motor" name="motor">
          </div>
          <div class="form-group col">
            <label>Tarjeta de Circulaci√≥n</label>
            <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.tarjeta_circulacion"
              name="tarjeta_circulacion">
          </div>
        </div>
        <hr>
        <div class="form-row">
          <div class="form-group col">
            <label>Raz√≥n Social</label>
            <select class="form-control" [(ngModel)]="autobusSeleccionado.razon_social" name="razon_social" required>
              <option value="" disabled>Selecciona una opci√≥n</option>
              <option *ngFor="let rs of razonesSociales" [value]="rs">{{ rs }}</option>
            </select>
          </div>
          <div class="form-group col">
            <label>Sistema de Emisiones</label>
            <select class="form-control" [(ngModel)]="autobusSeleccionado.sistema" name="sistema">
              <option value="" disabled>Selecciona una opci√≥n</option>
              <option *ngFor="let sistema of sistemasEmisiones" [value]="sistema">{{ sistema }}</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col">
            <label>Marca</label>
            <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.marca" name="marca">
          </div>
          <div class="form-group col">
            <label>Modelo</label>
            <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.modelo" name="modelo">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col">
            <label>A√±o</label>
            <input type="number" class="form-control" [(ngModel)]="autobusSeleccionado.anio" name="anio">
          </div>
          <div class="form-group col">
            <label>Kilometraje Actual</label>
            <input type="number" class="form-control" [(ngModel)]="autobusSeleccionado.kilometraje_actual"
              name="kilometraje_actual">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col">
            <label>HP (Caballos de Fuerza)</label>
            <input type="number" class="form-control" [(ngModel)]="autobusSeleccionado.hp" name="hp">
          </div>
          <div class="form-group col">
            <label>Carrocer√≠a</label>
            <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.carroceria" name="carroceria">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col">
            <label>Sistema El√©ctrico</label>
            <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.sistema_electrico"
              name="sistema_electrico">
          </div>
          <div class="form-group col">
            <label>Medida de Llanta</label>
            <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.medida_llanta"
              name="medida_llanta">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn-accion btn-guardar">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalDetalles" (click)="cerrarModalDetalles()">
  <div class="modal-content-ficha" (click)="$event.stopPropagation()" *ngIf="autobusParaDetalles">

    <!-- Header con dise√±o mejorado -->
    <div class="modal-header-ficha">
      <div class="header-content">
        <div class="header-icon">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="6" width="18" height="13" rx="2" />
            <circle cx="8.5" cy="18" r="2" />
            <circle cx="15.5" cy="18" r="2" />
            <path d="M3 11h18" />
          </svg>
        </div>
        <div class="header-text">
          <h2>Ficha T√©cnica del Autob√∫s</h2>
          <span class="economico-badge">No. {{ autobusParaDetalles.economico }}</span>
        </div>
      </div>
      <button class="btn-cerrar-ficha" (click)="cerrarModalDetalles()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
    </div>

    <!-- Body con cards organizadas -->
    <div class="modal-body-ficha">

      <!-- Informaci√≥n Principal -->
      <div class="info-section">
        <div class="section-title">
          <div class="title-icon">üìã</div>
          <h3>Informaci√≥n General</h3>
        </div>
        <div class="info-grid">
          <div class="info-card">
            <div class="info-icon">üé´</div>
            <div class="info-content">
              <span class="info-label">Placa</span>
              <span class="info-value">{{ autobusParaDetalles.placa }}</span>
            </div>
          </div>
          <div class="info-card">
            <div class="info-icon">üè¢</div>
            <div class="info-content">
              <span class="info-label">Raz√≥n Social</span>
              <span class="info-value">{{ autobusParaDetalles.razon_social }}</span>
            </div>
          </div>
          <div class="info-card">
            <div class="info-icon">üöç</div>
            <div class="info-content">
              <span class="info-label">Marca / Modelo</span>
              <span class="info-value">{{ autobusParaDetalles.marca }} / {{ autobusParaDetalles.modelo }}</span>
            </div>
          </div>
          <div class="info-card">
            <div class="info-icon">üìÖ</div>
            <div class="info-content">
              <span class="info-label">A√±o</span>
              <span class="info-value">{{ autobusParaDetalles.anio }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Especificaciones T√©cnicas -->
      <div class="info-section">
        <div class="section-title">
          <div class="title-icon">‚öôÔ∏è</div>
          <h3>Especificaciones T√©cnicas</h3>
        </div>
        <div class="info-grid">
          <div class="info-card">
            <div class="info-icon">üî¢</div>
            <div class="info-content">
              <span class="info-label">VIN</span>
              <span class="info-value small">{{ autobusParaDetalles.vin }}</span>
            </div>
          </div>
          <div class="info-card">
            <div class="info-icon">üî©</div>
            <div class="info-content">
              <span class="info-label">Chasis</span>
              <span class="info-value">{{ autobusParaDetalles.chasis }}</span>
            </div>
          </div>
          <div class="info-card">
            <div class="info-icon">üîß</div>
            <div class="info-content">
              <span class="info-label">Motor</span>
              <span class="info-value">{{ autobusParaDetalles.motor }}</span>
            </div>
          </div>
          <div class="info-card">
            <div class="info-icon">‚ö°</div>
            <div class="info-content">
              <span class="info-label">Potencia (HP)</span>
              <span class="info-value">{{ autobusParaDetalles.hp }}</span>
            </div>
          </div>
          <div class="info-card">
            <div class="info-icon">üí®</div>
            <div class="info-content">
              <span class="info-label">Sistema Emisiones</span>
              <span class="info-value">{{ autobusParaDetalles.sistema }}</span>
            </div>
          </div>
          <div class="info-card">
            <div class="info-icon">üîå</div>
            <div class="info-content">
              <span class="info-label">Sistema El√©ctrico</span>
              <span class="info-value">{{ autobusParaDetalles.sistema_electrico }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Caracter√≠sticas F√≠sicas -->
      <div class="info-section">
        <div class="section-title">
          <div class="title-icon">üìè</div>
          <h3>Caracter√≠sticas F√≠sicas</h3>
        </div>
        <div class="info-grid">
          <div class="info-card">
            <div class="info-icon">üö™</div>
            <div class="info-content">
              <span class="info-label">Carrocer√≠a</span>
              <span class="info-value">{{ autobusParaDetalles.carroceria }}</span>
            </div>
          </div>
          <div class="info-card">
            <div class="info-icon">üõû</div>
            <div class="info-content">
              <span class="info-label">Medida de Llanta</span>
              <span class="info-value">{{ autobusParaDetalles.medida_llanta }}</span>
            </div>
          </div>
          <div class="info-card highlight-card">
            <div class="info-icon">üìç</div>
            <div class="info-content">
              <span class="info-label">Kilometraje Actual</span>
              <span class="info-value large">{{ autobusParaDetalles.kilometraje_actual | number }} km</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Documentaci√≥n -->
      <div class="info-section">
        <div class="section-title">
          <div class="title-icon">üìÑ</div>
          <h3>Documentaci√≥n</h3>
        </div>
        <div class="info-grid">
          <div class="info-card">
            <div class="info-icon">üìÉ</div>
            <div class="info-content">
              <span class="info-label">Tarjeta de Circulaci√≥n</span>
              <span class="info-value">{{ autobusParaDetalles.tarjeta_circulacion }}</span>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Footer con acciones -->
    <div class="modal-footer-ficha">
      <button class="btn-secondary-ficha" (click)="cerrarModalDetalles()">
        Cerrar
      </button>
      <button class="btn-primary-ficha" (click)="editarDesdeDetalles()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
        </svg>
        Editar Autob√∫s
      </button>
    </div>

  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalBorrar" (click)="cerrarModalBorrar()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="header-eliminar">Confirmar Eliminaci√≥n</h3>
      <button class="btn-cerrar" (click)="cerrarModalBorrar()">√ó</button>
    </div>
    <div class="modal-body">
      <p class="confirm-text" *ngIf="autobusABorrar">¬øEst√°s seguro de que deseas eliminar el autob√∫s <strong>{{
          autobusABorrar.economico }}</strong>?</p>
      <p class="confirm-warning">Esta acci√≥n no se puede deshacer.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModalBorrar()">Cancelar</button>
      <button type="button" class="btn-accion btn-confirmar-eliminar" (click)="confirmarEliminacion()">S√≠,
        Eliminar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalNotificacion" (click)="cerrarModalNotificacion()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 [ngClass]="{
        'header-exito': notificacion.tipo === 'exito',
        'header-error': notificacion.tipo === 'error',
        'header-advertencia': notificacion.tipo === 'advertencia'
      }">
        {{ notificacion.titulo }}
      </h3>
      <button class="btn-cerrar" (click)="cerrarModalNotificacion()">√ó</button>
    </div>
    <div class="modal-body">
      <p class="confirm-text">{{ notificacion.mensaje }}</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-accion btn-guardar" (click)="cerrarModalNotificacion()">Aceptar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalHistorial" (click)="cerrarModalHistorial()">
  <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Historial de Mantenimiento: Autob√∫s #{{ autobusSeleccionadoEconomico }}</h3>
      <button class="btn-cerrar" (click)="cerrarModalHistorial()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="costo-total-container">
        <h4>Costo Total en Mantenimiento: <span>{{ costoTotalHistorial | currency:'MXN' }}</span></h4>
        <div class="export-actions">
          <button class="btn-mini-export btn-excel" (click)="exportarHistorialExcel()" title="Descargar Excel">
            <i class="fas fa-file-excel"></i> EXPORTAR EXCEL
          </button>
          <button class="btn-mini-export btn-pdf" (click)="exportarHistorialPDF()" title="Descargar PDF">
            <i class="fas fa-file-pdf"></i> EXPORTAR PDF
          </button>
        </div>
      </div>
      <div class="filtros-container-modal">
        <div class="filtro-item">
          <input type="text" class="form-control" placeholder="Filtrar por refacci√≥n o insumo..."
            [(ngModel)]="filtroHistorialItem" (input)="aplicarFiltroHistorial()">
        </div>
        <div class="filtro-item">
          <label>Desde:</label>
          <input type="date" class="form-control" [(ngModel)]="filtroHistorialFechaInicio"
            (change)="aplicarFiltroHistorial()">
        </div>
        <div class="filtro-item">
          <label>Hasta:</label>
          <input type="date" class="form-control" [(ngModel)]="filtroHistorialFechaFin"
            (change)="aplicarFiltroHistorial()">
        </div>
      </div>
      <div class="tabla-responsive-wrapper">
        <table class="tabla-preview">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Kilometraje</th>
              <th>Tipo</th>
              <th>Descripci√≥n</th>
              <th>Marca</th>
              <th>Cant.</th>
              <th>Costo Unit.</th>
              <th>Total</th>
              <th>Solicitado Por</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of historialFiltrado">
              <td>{{ item.fecha | date:'dd/MM/yy' }}</td>
              <td>{{ item.kilometraje | number }} km</td>
              <td>
                <span [class.tipo-refaccion]="item.tipo_item === 'Refacci√≥n'"
                  [class.tipo-insumo]="item.tipo_item === 'Insumo'">
                  {{ item.tipo_item }}
                </span>
              </td>
              <td style="font-weight: 500; color: #fff;">{{ item.nombre }}</td>
              <td>{{ item.marca || '-' }}</td>
              <td style="text-align: center;">{{ item.cantidad }}</td>

              <td class="text-end" style="color: #a0c4ff;">
                {{ item.costo_unitario | currency:'MXN' }}
              </td>
              <td class="text-end" style="font-weight: bold; color: #82c91e;">
                {{ item.costo_total | currency:'MXN' }}
              </td>

              <td>{{ item.solicitado_por }}</td>
            </tr>
            <tr *ngIf="historialFiltrado.length === 0">
              <td colspan="9" class="empty-table-message">No se encontraron movimientos.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModalHistorial()">Cerrar</button>
    </div>
  </div>
</div>
<div class="modal-overlay" *ngIf="mostrarModalSyncKm" (click)="cerrarModalSyncKm()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 *ngIf="autobusParaSync">Sincronizar KM para Cargas: {{ autobusParaSync.economico }}</h3>
      <button class="btn-cerrar" (click)="cerrarModalSyncKm()">√ó</button>
    </div>
    <div class="modal-body">
      <p class="confirm-text">
        Establece el kilometraje inicial que se usar√° para el pr√≥ximo c√°lculo de rendimiento de este autob√∫s.
      </p>
      <form (ngSubmit)="guardarSyncKm()">
        <div class="form-group">
          <label for="km_sync">Kilometraje de la √öltima Carga</label>
          <input id="km_sync" type="number" class="form-control" [(ngModel)]="kmSincronizar" name="kmSincronizar"
            required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModalSyncKm()">Cancelar</button>
          <button type="submit" class="btn-accion btn-guardar">Guardar Kilometraje</button>
        </div>
      </form>
    </div>
  </div>
</div>