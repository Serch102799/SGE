<div class="usuarios-container">
  <div class="container-header">
    <h2>Gesti贸n de Autobuses</h2>
    <button class="btn-agregar" (click)="abrirModal('agregar')" *ngIf="authService.hasRole(['Admin'])">
      <span>&#43;</span> Agregar Autob煤s
    </button>
  </div>

  <div class="container-body">
    <div class="filtros-container">
      <div class="filtro-item">
        <input type="text" class="form-control" placeholder="Filtrar por econ贸mico, raz贸n social, marca o VIN..."
          [(ngModel)]="terminoBusqueda" (input)="aplicarFiltros()">
      </div>
    </div>

     <div class="contador-resultados">
      <ng-container *ngIf="terminoBusqueda; else total">
        Mostrando <strong>{{ autobusesFiltrados.length }}</strong> de <strong>{{ autobuses.length }}</strong> autobuses
      </ng-container>
      <ng-template #total>
        <strong>{{ autobuses.length }}</strong> Autobuses en total
      </ng-template>
    </div>

    <div class="tabla-responsive-wrapper">
      <table class="tabla-usuarios">
        <thead>
          <tr>
            <th>N掳 Econ贸mico</th>
            <th>Raz贸n Social</th>
            <th>VIN</th>
            <th>Marca</th>
            <th>Modelo</th>
            <th>A帽o</th>
            <th>Kilometraje</th>
            <th style="text-align: center;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let autobus of autobusesFiltrados" (click)="abrirModalDetalles(autobus)" class="fila-clickable">
            <td>{{ autobus.economico }}</td>
            <td>{{ autobus.razon_social }}</td>
            <td>{{ autobus.vin }}</td>
            <td>{{ autobus.marca }}</td>
            <td>{{ autobus.modelo }}</td>
            <td>{{ autobus.anio }}</td>
            <td>{{ autobus.kilometraje_actual | number }} km</td>
            <td class="acciones" *ngIf="authService.hasRole(['Admin'])">
              <button class="btn-accion btn-historial" (click)="verHistorial(autobus)">Historial</button>
              <!-- <button class="btn-accion btn-estado" (click)="abrirModal('editar', autobus)">Editar</button> -->
              <button class="btn-accion btn-eliminar" (click)="abrirModalBorrar(autobus)">Eliminar</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModal" (click)="cerrarModal()">
  <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ modoEdicion ? 'Editar Autob煤s' : 'Agregar Nuevo Autob煤s' }}</h3>
      <button class="btn-cerrar" (click)="cerrarModal()"></button>
    </div>
    <div class="modal-body">
      <form (ngSubmit)="guardarAutobus()">
        <div class="form-row">
            <div class="form-group col">
                <label>N掳 Econ贸mico</label>
                <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.economico" name="economico" [disabled]="modoEdicion" required>
            </div>
            <div class="form-group col">
                <label>VIN (N煤mero de Serie)</label>
                <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.vin" name="vin" [disabled]="modoEdicion" required minlength="17" maxlength="17">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col">
                <label>Placa</label>
                <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.placa" name="placa" required>
            </div>
            <div class="form-group col">
                <label>Chasis</label>
                <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.chasis" name="chasis" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col">
                <label>Motor</label>
                <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.motor" name="motor">
            </div>
            <div class="form-group col">
                <label>Tarjeta de Circulaci贸n</label>
                <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.tarjeta_circulacion" name="tarjeta_circulacion">
            </div>
        </div>
        <hr>
        <div class="form-row">
            <div class="form-group col">
                <label>Raz贸n Social</label>
                <select class="form-control" [(ngModel)]="autobusSeleccionado.razon_social" name="razon_social" required>
                    <option value="" disabled>Selecciona una opci贸n</option>
                    <option *ngFor="let rs of razonesSociales" [value]="rs">{{ rs }}</option>
                </select>
            </div>
            <div class="form-group col">
                <label>Sistema de Emisiones</label>
                <select class="form-control" [(ngModel)]="autobusSeleccionado.sistema" name="sistema">
                    <option value="" disabled>Selecciona una opci贸n</option>
                    <option *ngFor="let sistema of sistemasEmisiones" [value]="sistema">{{ sistema }}</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col">
                <label>Marca</label>
                <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.marca" name="marca">
            </div>
            <div class="form-group col">
                <label>Modelo</label>
                <input type="text" class="form-control" [(ngModel)]="autobusSeleccionado.modelo" name="modelo">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col">
                <label>A帽o</label>
                <input type="number" class="form-control" [(ngModel)]="autobusSeleccionado.anio" name="anio">
            </div>
            <div class="form-group col">
                <label>Kilometraje Actual</label>
                <input type="number" class="form-control" [(ngModel)]="autobusSeleccionado.kilometraje_actual" name="kilometraje_actual">
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn-accion btn-guardar">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalBorrar" (click)="cerrarModalBorrar()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="header-eliminar">Confirmar Eliminaci贸n</h3>
      <button class="btn-cerrar" (click)="cerrarModalBorrar()"></button>
    </div>
    <div class="modal-body">
      <p class="confirm-text" *ngIf="autobusABorrar">驴Est谩s seguro de que deseas eliminar el autob煤s <strong>{{
          autobusABorrar.economico }}</strong>?</p>
      <p class="confirm-warning">Esta acci贸n no se puede deshacer.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModalBorrar()">Cancelar</button>
      <button type="button" class="btn-accion btn-confirmar-eliminar" (click)="confirmarEliminacion()">S铆,
        Eliminar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalNotificacion" (click)="cerrarModalNotificacion()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 [ngClass]="{
        'header-exito': notificacion.tipo === 'exito',
        'header-error': notificacion.tipo === 'error',
        'header-advertencia': notificacion.tipo === 'advertencia'
      }">
        {{ notificacion.titulo }}
      </h3>
      <button class="btn-cerrar" (click)="cerrarModalNotificacion()"></button>
    </div>
    <div class="modal-body">
      <p class="confirm-text">{{ notificacion.mensaje }}</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-accion btn-guardar" (click)="cerrarModalNotificacion()">Aceptar</button>
    </div>
  </div>
</div>
<div class="modal-overlay" *ngIf="mostrarModalHistorial" (click)="cerrarModalHistorial()">
  <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Historial de Mantenimiento: Autob煤s #{{ autobusSeleccionadoEconomico }}</h3>
      <button class="btn-cerrar" (click)="cerrarModalHistorial()"></button>
    </div>
    <div class="modal-body">
      
      <div class="costo-total-container">
        <h4>Costo Total en Mantenimiento: <span>{{ costoTotalHistorial | currency:'MXN' }}</span></h4>
      </div>
      
      <div class="filtros-container-modal">
        <div class="filtro-item">
          <input type="text" class="form-control" placeholder="Filtrar por refacci贸n o insumo..."
                 [(ngModel)]="filtroHistorialItem" (input)="aplicarFiltroHistorial()">
        </div>
        <div class="filtro-item">
          <label>Desde:</label>
          <input type="date" class="form-control" [(ngModel)]="filtroHistorialFechaInicio" (change)="aplicarFiltroHistorial()">
        </div>
        <div class="filtro-item">
          <label>Hasta:</label>
          <input type="date" class="form-control" [(ngModel)]="filtroHistorialFechaFin" (change)="aplicarFiltroHistorial()">
        </div>
      </div>

      <div class="tabla-responsive-wrapper">
        <table class="tabla-preview">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Kilometraje</th>
              <th>Tipo</th>
              <th>Descripci贸n</th>
              <th>Marca</th>
              <th>Cantidad</th>
              <th>Solicitado Por</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of historialFiltrado">
              <td>{{ item.fecha | date:'short' }}</td>
              <td>{{ item.kilometraje | number }} km</td>
              <td>
                <span [class.tipo-refaccion]="item.tipo_item === 'Refacci贸n'"
                      [class.tipo-insumo]="item.tipo_item === 'Insumo'">
                  {{ item.tipo_item }}
                </span>
              </td>
              <td>{{ item.nombre }}</td>
              <td>{{ item.marca }}</td>
              <td>{{ item.cantidad }}</td>
              <td>{{ item.solicitado_por }}</td>
            </tr>
            <tr *ngIf="historialFiltrado.length === 0">
              <td colspan="7" class="empty-table-message">No se encontraron movimientos.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModalHistorial()">Cerrar</button>
    </div>
  </div>
</div>
<div class="modal-overlay" *ngIf="mostrarModalDetalles" (click)="cerrarModalDetalles()">
  <div class="modal-content modal-lg" (click)="$event.stopPropagation()" *ngIf="autobusParaDetalles">
    <div class="modal-header modal-header-detalles">
      <h3> Detalles del Autob煤s: {{ autobusParaDetalles.economico }}</h3>
      <button class="btn-cerrar" (click)="cerrarModalDetalles()"></button>
    </div>
    <div class="modal-body">
      <div class="detalles-grid">
        <div class="detalle-columna">
          <div class="detalle-item">
            <span class="detalle-label">Placa:</span>
            <span class="detalle-valor">{{ autobusParaDetalles.placa }}</span>
          </div>
          <div class="detalle-item">
            <span class="detalle-label">VIN:</span>
            <span class="detalle-valor">{{ autobusParaDetalles.vin }}</span>
          </div>
          <div class="detalle-item">
            <span class="detalle-label">Chasis:</span>
            <span class="detalle-valor">{{ autobusParaDetalles.chasis }}</span>
          </div>
          <div class="detalle-item">
            <span class="detalle-label">Motor:</span>
            <span class="detalle-valor">{{ autobusParaDetalles.motor }}</span>
          </div>
          <div class="detalle-item">
            <span class="detalle-label">Tarjeta de Circulaci贸n:</span>
            <span class="detalle-valor">{{ autobusParaDetalles.tarjeta_circulacion }}</span>
          </div>
        </div>
        <div class="detalle-columna">
          <div class="detalle-item">
            <span class="detalle-label">Raz贸n Social:</span>
            <span class="detalle-valor">{{ autobusParaDetalles.razon_social }}</span>
          </div>
          <div class="detalle-item">
            <span class="detalle-label">Marca / Modelo:</span>
            <span class="detalle-valor">{{ autobusParaDetalles.marca }} / {{ autobusParaDetalles.modelo }}</span>
          </div>
          <div class="detalle-item">
            <span class="detalle-label">A帽o:</span>
            <span class="detalle-valor">{{ autobusParaDetalles.anio }}</span>
          </div>
          <div class="detalle-item">
            <span class="detalle-label">Kilometraje Actual:</span>
            <span class="detalle-valor">{{ autobusParaDetalles.kilometraje_actual | number }} km</span>
          </div>
          <div class="detalle-item">
            <span class="detalle-label">Sistema Emisiones:</span>
            <span class="detalle-valor">{{ autobusParaDetalles.sistema }}</span>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-accion btn-historial" (click)="verHistorialDesdeDetalles()">Ver Historial</button>
      <button type="button" class="btn-accion btn-estado" (click)="editarDesdeDetalles()">Editar Autob煤s</button>
      <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModalDetalles()">Cerrar</button>
    </div>
  </div>
</div>