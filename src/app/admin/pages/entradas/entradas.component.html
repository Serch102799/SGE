<div class="usuarios-container">
  <div class="container-header">
    <h2>Historial de Entradas a Almacén</h2>
    <div class="acciones-header">
      <button class="btn-exportar" (click)="exportarAExcelCompleto()">
        <span>&#128196;</span> EXPORTAR EXCEL
      </button>
      <button class="btn-exportar btn-pdf" (click)="exportarAPDFCompleto()">
        <span>&#128462;</span> EXPORTAR PDF
      </button>
      <button class="btn-agregar" (click)="registrarNuevaEntrada()">
        <span>&#43;</span> Registrar Nueva Entrada
      </button>
    </div>
  </div>

  <div class="filtros-container">
    <div class="filtro-item">
      <input type="text" class="form-control" placeholder="Buscar por proveedor, factura o empleado..."
        [(ngModel)]="terminoBusqueda" (ngModelChange)="onFiltroChange()">
    </div>
    <div class="filtro-item">
      <label for="fechaInicio">Desde:</label>
      <input id="fechaInicio" type="date" class="form-control" [(ngModel)]="fechaInicio"
        (ngModelChange)="onFiltroChange()">
    </div>
    <div class="filtro-item">
      <label for="fechaFin">Hasta:</label>
      <input id="fechaFin" type="date" class="form-control" [(ngModel)]="fechaFin" (ngModelChange)="onFiltroChange()">
    </div>
  </div>

  <div class="tabla-responsive-wrapper">
    <table class="tabla-usuarios">
      <thead>
        <tr>
          <th>Fecha Operación</th>
          <th>Proveedor</th>
          <th>Factura / Vale</th>
          <th>Recibido Por</th>
          <th>Observaciones</th>
          <th>Total</th>
          <th style="text-align: center;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let entrada of entradas | paginate: { itemsPerPage: itemsPerPage, currentPage: currentPage, totalItems: totalItems }"
          [class.fila-cancelada]="entrada.estado === 'CANCELADO'">
          <td>{{ entrada.fechaEntrada | date:'dd/MM/yyyy h:mm a' }}</td>
          <td>{{ entrada.nombreProveedor }}</td>
          <td>
            <div *ngIf="entrada.factura_proveedor" class="documento-linea">
              <strong>Factura:</strong> {{ entrada.factura_proveedor }}
            </div>
            <div *ngIf="entrada.vale_interno" class="documento-linea">
              <strong>Vale:</strong> {{ entrada.vale_interno }}
            </div>
          </td>
          <td>{{ entrada.nombreEmpleado }}</td>
          <td>
            <span *ngIf="entrada.estado === 'CANCELADO'" class="badge bg-danger me-1">CANCELADO</span>
            {{ entrada.observaciones }}
          </td>
          <td><strong>{{ entrada.valor_neto | currency:'MXN' }}</strong></td>

          <td class="acciones">
            <div class="btn-group">

              <button class="btn-accion btn-estado" (click)="verDetalles(entrada)" title="Ver Detalles">
                <span class="d-none d-md-inline">Detalles</span>Ver Detalles
              </button>
              <button *ngIf="authService.hasRole(['SuperUsuario', 'Admin', 'SuperAdmin'])"
                class="btn-accion btn-cancelar-icon" title="Anular Entrada" (click)="abrirModalCancelar(entrada)">
                <span class="d-none d-md-inline">Anular</span>Cancelar
                <i class="fas fa-ban"></i>
              </button>

              <ng-container
                *ngIf="authService.hasRole(['SuperUsuario', 'SuperAdmin', 'Admin']) && entrada.estado !== 'CANCELADO'">

                <!-- <button class="btn-accion btn-editar" (click)="abrirEdicionHistorica(entrada)" title="Editar Entrada">
                  <i class="fas fa-edit"></i>Editar
                </button>

                <button class="btn-accion btn-cancelar-icon" (click)="cancelarEntrada(entrada)"
                  title="Cancelar Entrada">
                  <i class="fas fa-ban"></i>Cancelar
                </button> -->

              </ng-container>

            </div>
          </td>
        </tr>

        <tr *ngIf="entradas.length === 0">
          <td colspan="7" class="empty-table-message">No se encontraron entradas que coincidan con los filtros.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="pagination-controls">
    <pagination-controls (pageChange)="onPageChange($event)" previousLabel="Anterior" nextLabel="Siguiente">
    </pagination-controls>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalDetalles" (click)="cerrarModalDetalles()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Detalles de la Entrada #{{ entradaSeleccionadaId }}</h3>
      <button class="btn-cerrar" (click)="cerrarModalDetalles()">×</button>
    </div>
    <div class="modal-body">
      <div class="tabla-responsive-wrapper">
        <table class="tabla-preview tabla-ticket">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Descripción</th>
              <th style="text-align: right;">Cantidad</th>
              <th style="text-align: right;">Costo Unitario Final</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let detalle of detallesSeleccionados">
              <td>
                <span class="badge"
                  [ngClass]="{'badge-refaccion': detalle.tipo_item === 'Refacción', 'badge-insumo': detalle.tipo_item === 'Insumo'}">
                  {{ detalle.tipo_item }}
                </span>
              </td>
              <td>{{ detalle.descripcion }}</td>
              <td style="text-align: right;">{{ detalle.cantidad | number:'1.2-2' }}</td>
              <td style="text-align: right;">{{ detalle.costo | currency:'MXN' }}</td>
            </tr>
            <tr *ngIf="detallesSeleccionados.length === 0">
              <td colspan="4" class="empty-table-message">Esta entrada no tiene items registrados.</td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="fila-total">
              <td colspan="3" class="label-total">Total de la Entrada:</td>
              <td class="valor-total">{{ valorNetoEntradaSeleccionada | currency:'MXN' }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModalDetalles()">Cerrar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalEdicion" (click)="cerrarModalEdicion()">
  <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-header bg-warning-dark">
      <h3><i class="fas fa-tools"></i> Edición Histórica - Entrada #{{ entradaEdicion.id_entrada }}</h3>
      <button class="btn-cerrar" (click)="cerrarModalEdicion()">×</button>
    </div>

    <div class="modal-body">
      <div class="alert alert-warning d-flex align-items-center mb-3">
        <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
        <div>
          <strong>¡Cuidado!</strong> Estás editando un registro histórico.
          Cambiar cantidades ajustará el stock actual automáticamente.
          <br><em>No podrás disminuir cantidades por debajo de lo que ya se ha consumido.</em>
        </div>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <label class="form-label">Proveedor</label>
          <select class="form-select" [(ngModel)]="entradaEdicion.id_proveedor">
            <option *ngFor="let p of proveedores" [value]="p.id_proveedor">{{p.nombre_proveedor}}</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Fecha Operación</label>
          <input type="datetime-local" class="form-control" [(ngModel)]="entradaEdicion.fecha_operacion">
        </div>
        <div class="col-md-6">
          <label class="form-label">Factura / Vale</label>
          <input type="text" class="form-control" [(ngModel)]="entradaEdicion.factura_proveedor">
        </div>
        <div class="col-md-6">
          <label class="form-label">Observaciones</label>
          <input type="text" class="form-control" [(ngModel)]="entradaEdicion.observaciones">
        </div>
      </div>

      <h5 class="border-bottom pb-2 mb-3">Items de la Entrada</h5>
      <div class="tabla-responsive-wrapper" style="max-height: 300px; overflow-y: auto;">
        <table class="tabla-usuarios table-sm">
          <thead>
            <tr>
              <th>Item</th>
              <th class="text-center" width="120">Cant. Original</th>
              <th class="text-center" width="120">Nueva Cant.</th>
              <th class="text-center" width="120">Costo Original</th>
              <th class="text-center" width="120">Nuevo Costo</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of entradaEdicion.items">
              <td>
                <div class="fw-bold">{{ item.nombre }}</div>
                <small class="text-muted">{{ item.tipo | uppercase }}</small>
              </td>

              <td class="text-center text-muted">{{ item.cantidad_original }}</td>
              <td>
                <input type="number" class="form-control form-control-sm text-center" [(ngModel)]="item.cantidad_nueva"
                  [min]="item.cantidad_usada" [title]="'Mínimo permitido: ' + item.cantidad_usada">
                <div *ngIf="item.cantidad_usada > 0" class="text-danger" style="font-size: 0.7rem;">
                  Min: {{item.cantidad_usada}} (Usados)
                </div>
              </td>

              <td class="text-center text-muted">{{ item.costo_original | currency }}</td>
              <td>
                <input type="number" class="form-control form-control-sm text-center" [(ngModel)]="item.costo_nuevo">
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="modal-footer justify-content-between">
      <small class="text-muted">ID Auditoría: {{ entradaEdicion.id_entrada }}</small>
      <div>
        <button type="button" class="btn-accion btn-cancelar me-2" (click)="cerrarModalEdicion()">Cancelar</button>
        <button type="button" class="btn-accion btn-guardar" (click)="guardarEdicionHistorica()">
          <i class="fas fa-save"></i> Guardar Cambios
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalNotificacion" (click)="cerrarModalNotificacion()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 [ngClass]="{
        'header-exito': notificacion.tipo === 'exito',
        'header-error': notificacion.tipo === 'error',
        'header-advertencia': notificacion.tipo === 'advertencia'
      }">
        {{ notificacion.titulo }}
      </h3>
      <button class="btn-cerrar" (click)="cerrarModalNotificacion()">×</button>
    </div>
    <div class="modal-body">
      <p class="confirm-text">{{ notificacion.mensaje }}</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-accion btn-guardar" (click)="cerrarModalNotificacion()">Aceptar</button>
    </div>
  </div>
</div>
<div class="modal-overlay" *ngIf="mostrarModalCancelar" style="z-index: 2100;">
  <div class="modal-content danger-modal" (click)="$event.stopPropagation()">
    
    <div class="modal-header header-error">
      <h3><i class="fas fa-exclamation-triangle"></i> Cancelar Entrada</h3>
    </div>
    
    <div class="modal-body">
      <div class="alert alert-danger-custom">
        <strong>¡ATENCIÓN!</strong> Estás a punto de anular la entrada con factura/vale: 
        <strong class="text-white">{{ entradaACancelar?.factura_proveedor || entradaACancelar?.vale_interno || 'S/D' }}</strong>.
        <br><br>
        Esto restará del stock actual las cantidades ingresadas. Si el sistema detecta que parte del material <strong>ya fue utilizado</strong>, la operación será bloqueada.
      </div>

      <div class="form-group mt-3">
        <label>Motivo de la Cancelación</label>
        <select class="form-control" [(ngModel)]="motivoCancelacion" [disabled]="isCanceling">
          <option value="" disabled selected>Seleccione un motivo...</option>
          <option value="Error de captura (Duplicado)">Error de captura (Duplicado / Fallo de Red)</option>
          <option value="Devolución a proveedor (Garantía)">Devolución a proveedor (Garantía)</option>
          <option value="Mercancía incorrecta / Dañada">Mercancía incorrecta / Dañada</option>
          <option value="Otro">Otro...</option>
        </select>
      </div>

      <div class="form-group mt-2 animation-fade-in" *ngIf="motivoCancelacion === 'Otro'">
        <label>Especifique el motivo detallado</label>
        <textarea class="form-control" [(ngModel)]="motivoDetalle" rows="2" placeholder="Describe brevemente por qué se anula esta entrada..." [disabled]="isCanceling"></textarea>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn-cancelar" (click)="cerrarModalCancelar()" [disabled]="isCanceling">Volver</button>
      
      <button class="btn-guardar btn-danger-neon" 
              (click)="confirmarCancelacion()" 
              [disabled]="isCanceling || !motivoCancelacion || (motivoCancelacion === 'Otro' && !motivoDetalle)">
        <i class="fas" [ngClass]="isCanceling ? 'fa-spinner fa-spin' : 'fa-skull-crossbones'"></i>
        {{ isCanceling ? 'Procesando...' : 'Anular Definitivamente' }}
      </button>
    </div>

  </div>
</div>