<div class="usuarios-container">
    <div class="container-header">
        <h2>Historial de Vales de Salida</h2>
        <div class="acciones-header">
            <button class="btn-exportar" (click)="exportarAExcelCompleto()">
                <span>&#128196;</span> EXPORTAR EXCEL
            </button>

            <button class="btn-exportar btn-pdf" (click)="exportarAPDFCompleto()">
                <span>&#128462;</span> EXPORTAR PDF
            </button>
            <button class="btn-agregar" (click)="registrarNuevaSalida()">
                <span>&#43;</span> Registrar Nuevo Vale
            </button>
        </div>
    </div>

    <div class="container-body">
        <div class="filtros-container">
            <div class="filtro-item">
                <input type="text" class="form-control" placeholder="Buscar por económico, tipo o empleado..."
                    [(ngModel)]="terminoBusqueda" (ngModelChange)="onFiltroChange()">
            </div>
            <div class="filtro-item">
                <label>Desde:</label>
                <input type="date" class="form-control" [(ngModel)]="fechaInicio" (change)="onFiltroChange()">
            </div>
            <div class="filtro-item">
                <label>Hasta:</label>
                <input type="date" class="form-control" [(ngModel)]="fechaFin" (change)="onFiltroChange()">
            </div>
        </div>

        <div class="contador-resultados">
            <strong>{{ totalItems }}</strong> vales de salida encontrados
        </div>

        <div class="tabla-responsive-wrapper">
            <table class="tabla-usuarios">
                <thead>
                    <tr>
                        <!-- <th>ID</th> -->
                        <th>Fecha Operación</th>
                        <th>Tipo</th>
                        <th>Autobús</th>
                        <th>Kilometraje</th>
                        <th>Solicitado Por</th>
                        <th style="text-align: center;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr
                        *ngFor="let salida of salidas | paginate: { itemsPerPage: itemsPerPage, currentPage: currentPage, totalItems: totalItems }">
                        <!-- <td>{{ salida.idSalida }}</td> -->
                        <td>{{ salida.fechaSalida | date:'dd/MM/yyyy h:mm a' }}</td>
                        <td>{{ salida.tipoSalida }}</td>
                        <td>{{ salida.economicoAutobus }}</td>
                        <td>{{ salida.kilometrajeAutobus | number }} km</td>
                        <td>{{ salida.nombreEmpleado }}</td>
                        <td class="acciones">
                            <button class="btn-accion btn-detalles" (click)="verDetalles(salida)">Ver Detalles</button>
                            <button class="btn-accion btn-agregar-items" (click)="abrirModalAgregarItems(salida)"
                                *ngIf="authService.hasRole(['Admin', 'Almacenista'])">Agregar</button>
                        </td>
                    </tr>
                    <tr *ngIf="salidas.length === 0">
                        <td colspan="7" class="empty-table-message">No se encontraron salidas que coincidan con los
                            filtros.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination-controls">
            <pagination-controls (pageChange)="onPageChange($event)" previousLabel="Anterior" nextLabel="Siguiente">
            </pagination-controls>
        </div>
    </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalDetalles" (click)="cerrarModalDetalles()">
    <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Detalles de la Salida #{{ salidaSeleccionadaId }}</h3>
            <button class="btn-cerrar" (click)="cerrarModalDetalles()">×</button>
        </div>
        <div class="modal-body">
            <div class="tabla-responsive-wrapper">
                <table class="tabla-preview tabla-ticket">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Descripción</th>
                            <th>Cant. Salida</th>
                            <th>Cant. Devuelta</th>
                            <th>Cant. Neta</th>
                            <th>Costo Unitario</th>
                            <th>Costo Total</th>
                            <th *ngIf="authService.hasRole(['SuperUsuario'])" style="text-align: center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let detalle of detallesSeleccionados">
                            <td>
                                <span class="badge"
                                    [ngClass]="{'badge-refaccion': detalle.tipo_item === 'refaccion', 'badge-insumo': detalle.tipo_item === 'insumo'}">{{
                                    detalle.tipo_item }}</span>
                            </td>
                            <td>{{ detalle.nombre_item }}</td>
                            <td>{{ detalle.cantidad | number:'1.2-2' }}</td>
                            <td>{{ (detalle.cantidad_devuelta || 0) | number:'1.2-2' }}</td>
                            <td><strong>{{ (detalle.cantidad - (detalle.cantidad_devuelta || 0)) | number:'1.2-2'
                                    }}</strong></td>
                            <td>{{ detalle.costo_unitario | currency:'MXN' }}</td>
                            <td><strong>{{ ((detalle.cantidad - (detalle.cantidad_devuelta || 0)) *
                                    detalle.costo_unitario) | currency:'MXN' }}</strong></td>
                            <td class="acciones" *ngIf="authService.hasRole(['SuperUsuario'])">
                                <button class="btn-accion btn-devolucion"
                                    *ngIf="(detalle.cantidad - (detalle.cantidad_devuelta || 0)) > 0"
                                    (click)="abrirModalDevolucion(detalle)">
                                    Devolver
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModalDetalles()">Cerrar</button>
        </div>
    </div>
</div>
<div class="modal-overlay" *ngIf="mostrarModalAgregarItems" (click)="cerrarModalAgregarItems()">
    <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3 *ngIf="salidaSeleccionada">Agregar Items al Vale de Salida #{{ salidaSeleccionada.idSalida }}</h3>
            <button class="btn-cerrar" (click)="cerrarModalAgregarItems()">×</button>
        </div>
        <div class="modal-body">

            <fieldset class="form-section-sm">
                <legend>Items Existentes</legend>
                <ul class="lista-items-existentes">
                    <li *ngFor="let item of itemsExistentes">
                        <span class="badge"
                            [ngClass]="{'badge-refaccion': item.tipo_item === 'Refacción', 'badge-insumo': item.tipo_item === 'Insumo'}">{{
                            item.tipo_item }}</span>
                        {{ item.nombre_item }} - Cantidad: {{ item.cantidad }}
                    </li>
                    <li *ngIf="itemsExistentes.length === 0">Esta salida aún no tiene items registrados.</li>
                </ul>
            </fieldset>

            <fieldset class="form-section-sm">
                <legend>Agregar Nueva Refacción</legend>
                <div class="form-row align-items-end">
                    <div class="form-group col-md-5">
                        <label>Buscar Refacción</label>
                        <mat-form-field appearance="outline" class="full-width">
                            <input type="text" placeholder="Escribe para buscar..." matInput
                                [formControl]="refaccionControl" [matAutocomplete]="autoRefaccion">
                        </mat-form-field>
                        <mat-autocomplete #autoRefaccion="matAutocomplete" [displayWith]="displayFn"
                            (optionSelected)="onRefaccionSelectedEnModal($event)">
                            <mat-option *ngFor="let refaccion of filteredRefacciones$ | async" [value]="refaccion">
                                {{ refaccion.nombre }} ({{ refaccion.numero_parte || 'S/N' }})
                            </mat-option>
                        </mat-autocomplete>
                    </div>
                    <div class="form-group col-md-3">
                        <label>Lote</label>
                        <select class="form-control" [(ngModel)]="detalleActualRefaccion.id_lote" name="id_lote_modal">
                            <option [ngValue]="null" disabled>Selecciona un lote...</option>
                            <option *ngFor="let lote of lotesDisponibles" [ngValue]="lote.id_lote">
                                {{ lote.nombre_proveedor }} (Disp: {{ lote.cantidad_disponible }})
                            </option>
                        </select>
                    </div>
                    <div class="form-group col-md-2">
                        <label>Cantidad</label>
                        <input type="number" class="form-control"
                            [(ngModel)]="detalleActualRefaccion.cantidad_despachada" name="cantidad_despachada_modal"
                            min="1">
                    </div>
                    <div class="form-group-button">
                        <button type="button" class="btn-agregar-detalle" (click)="agregarNuevaRefaccion()">+</button>
                    </div>
                </div>
                <ul class="lista-items-nuevos">
                    <li *ngFor="let item of itemsNuevosRefacciones">
                        <span>✅ {{ item.nombre_refaccion }} (Lote: {{ item.nombre_proveedor }}) - Cantidad: {{
                            item.cantidad_despachada }}</span>
                    </li>
                </ul>
            </fieldset>

            <fieldset class="form-section-sm">
                <legend>Agregar Nuevo Insumo</legend>
                <div class="form-row align-items-end">
                    <div class="form-group col-md-8">
                        <label>Buscar Insumo</label>
                        <mat-form-field appearance="outline" class="full-width">
                            <input type="text" placeholder="Escribe para buscar..." matInput
                                [formControl]="insumoControl" [matAutocomplete]="autoInsumo">
                        </mat-form-field>
                        <mat-autocomplete #autoInsumo="matAutocomplete" [displayWith]="displayFn"
                            (optionSelected)="onInsumoSelectedEnModal($event)">
                            <mat-option *ngFor="let insumo of filteredInsumos$ | async" [value]="insumo">
                                {{ insumo.nombre }} (Stock: {{ insumo.stock_actual }})
                            </mat-option>
                        </mat-autocomplete>
                    </div>
                    <div class="form-group col-md-2">
                        <label>Cantidad</label>
                        <input type="number" step="0.01" class="form-control"
                            [(ngModel)]="detalleActualInsumo.cantidad_usada" name="cantidad_usada_modal" min="0.01">
                    </div>
                    <div class="form-group-button">
                        <button type="button" class="btn-agregar-detalle" (click)="agregarNuevoInsumo()">+</button>
                    </div>
                </div>
                <ul class="lista-items-nuevos">
                    <li *ngFor="let item of itemsNuevosInsumos">
                        <span>✅ {{ item.nombre_insumo }} - Cantidad: {{ item.cantidad_usada }}</span>
                    </li>
                </ul>
            </fieldset>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModalAgregarItems()">Cancelar</button>
            <button type="button" class="btn-accion btn-guardar" (click)="guardarItemsAdicionales()">Guardar
                Items</button>
        </div>
    </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalNotificacion" (click)="cerrarModalNotificacion()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3 [ngClass]="{
                'header-exito': notificacion.tipo === 'exito',
                'header-error': notificacion.tipo === 'error',
                'header-advertencia': notificacion.tipo === 'advertencia'
            }">
                {{ notificacion.titulo }}
            </h3>
            <button class="btn-cerrar" (click)="cerrarModalNotificacion()">×</button>
        </div>
        <div class="modal-body">
            <p class="confirm-text">{{ notificacion.mensaje }}</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-accion btn-guardar" (click)="cerrarModalNotificacion()">Aceptar</button>
        </div>
    </div>
</div>
<div class="modal-overlay" *ngIf="mostrarModalDevolucion" (click)="cerrarModalDevolucion()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3 *ngIf="itemParaDevolucion">Registrar Devolución de: {{ itemParaDevolucion.nombre }}</h3>
            <button class="btn-cerrar" (click)="cerrarModalDevolucion()">×</button>
        </div>
        <div class="modal-body">
            <form (ngSubmit)="guardarDevolucion()">
                <div class="form-group">
                    <label for="cantidad_devuelta">Cantidad a Devolver (Máx: {{ itemParaDevolucion.cantidad }})</label>
                    <input id="cantidad_devuelta" type="number" class="form-control"
                        [(ngModel)]="datosDevolucion.cantidad_devuelta" name="cantidad_devuelta"
                        [max]="itemParaDevolucion.cantidad" min="0.01" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="motivo_devolucion">Motivo de la Devolución (Obligatorio)</label>
                    <textarea id="motivo_devolucion" class="form-control" [(ngModel)]="datosDevolucion.motivo"
                        name="motivo_devolucion" rows="3" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-accion btn-cancelar"
                        (click)="cerrarModalDevolucion()">Cancelar</button>
                    <button type="submit" class="btn-accion btn-guardar"
                        [disabled]="!datosDevolucion.motivo || !datosDevolucion.cantidad_devuelta">Confirmar
                        Devolución</button>
                </div>
            </form>
        </div>
    </div>
</div>