<div class="usuarios-container">
  
  <div class="card mb-4">
    <div class="card-header">
      <h4>
        <i class="fas fa-user-shield"></i>
        Panel de Administración de Sesiones
      </h4>
      <button (click)="cargarSesionesActivas()" 
              [disabled]="cargandoSesiones"
              class="btn-accion btn-primary">
        <i class="fas fa-sync" [ngClass]="{'fa-spin': cargandoSesiones}"></i>
        <span *ngIf="!cargandoSesiones">Refrescar</span>
      </button>
    </div>

    <div class="card-body">
      <div *ngIf="cargandoSesiones" class="text-center p-4">
        <div class="spinner-border text-primary" style="color: #4480d3;"></div>
        <p class="mt-2 text-white">Cargando sesiones...</p>
      </div>

      <div *ngIf="errorSesiones" class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i>
        <div>
          <h5 class="mb-0">Error</h5>
          <p class="mb-0">{{ errorSesiones }}</p>
        </div>
      </div>

      <div *ngIf="!cargandoSesiones && !errorSesiones && sesionesActivas.length === 0" class="text-center p-4 text-muted">
        <i class="fas fa-check-circle fa-2x mb-2"></i>
        <h5>No hay sesiones activas</h5>
        <p>Todo está tranquilo por ahora.</p>
      </div>

      <div *ngIf="!cargandoSesiones && !errorSesiones && sesionesActivas.length > 0">
        <div class="table-responsive">
          <table class="table-usuarios">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Puesto</th>
                <th>Inicio de Sesión</th>
                <th>IP / Navegador</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let sesion of sesionesActivas | paginate: { id: 'pag_sesiones', itemsPerPage: limitSesiones, currentPage: pageSesiones }" 
                  [class.loading]="sesion.cerrando">
                <td data-label="Usuario">
                  <strong>{{ sesion.nombre }}</strong>
                </td>
                <td data-label="Puesto">
                  {{ sesion.puesto || '-' }}
                </td>
                <td data-label="Inicio">
                  {{ sesion.fecha_login | date:'dd/MM/yy, h:mm:ss a' }}
                </td>
                <td data-label="IP / Nav">
                  <div style="font-size: 0.85rem; color: #fff;">{{ sesion.ip_address || 'Desconocida' }}</div>
                  <div class="text-truncate" style="max-width: 250px; font-size: 0.75rem; color: #aaa;" [title]="sesion.user_agent">
                    {{ sesion.user_agent || '-' }}
                  </div>
                </td>
                <td data-label="Acciones" class="d-flex gap-2">
                  <button (click)="onVerHistorial(sesion)" 
                          [disabled]="sesion.cerrando"
                          class="btn-accion btn-historial">
                    <i class="fas fa-history"></i> Historial
                  </button>
                  <button (click)="onForzarCierre(sesion)"
                          [disabled]="sesion.cerrando"
                          class="btn-accion btn-danger">
                    <i class="fas fa-sign-out-alt"></i> Cerrar
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pagination-controls">
          <pagination-controls 
            id="pag_sesiones"
            (pageChange)="pageSesiones = $event"
            previousLabel="Anterior"
            nextLabel="Siguiente">
          </pagination-controls>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h4>
        <i class="fas fa-list-alt"></i>
        Registro Global de Auditoría
      </h4>
      
      <div class="search-box">
        <input type="text" 
               class="form-control" 
               placeholder="Buscar usuario, acción..." 
               [(ngModel)]="searchAuditoria"
               (keyup.enter)="onSearchAuditoria()">
        <button class="btn-accion btn-primary" (click)="onSearchAuditoria()">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </div>

    <div class="card-body">
      <div *ngIf="cargandoAuditoria" class="text-center p-4">
        <div class="spinner-border text-light"></div>
        <p class="mt-2 text-white">Cargando registros...</p>
      </div>

      <div *ngIf="!cargandoAuditoria">
        <div class="table-responsive">
          <table class="table-usuarios">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Usuario</th>
                <th>Acción</th>
                <th>Recurso</th>
                <th>Detalles</th>
                <th>IP</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let accion of auditoriaGeneral | paginate: { id: 'pag_auditoria', itemsPerPage: limitAuditoria, currentPage: pageAuditoria, totalItems: totalAuditoria }">
                <td style="white-space: nowrap; font-size: 0.85rem;">
                  {{ accion.timestamp | date:'dd/MM/yy HH:mm' }}
                </td>
                <td style="font-weight: 600; color: #4480d3;">
                  {{ accion.nombre_usuario || 'Sistema' }}
                </td>
                <td>
                  <span class="badge" [ngClass]="{
                    'bg-success': accion.tipo_accion.includes('CREAR') || accion.tipo_accion.includes('LOGIN'),
                    'bg-warning': accion.tipo_accion.includes('EDITAR') || accion.tipo_accion.includes('ACTUALIZAR'),
                    'bg-danger': accion.tipo_accion.includes('ELIMINAR'),
                    'bg-info': accion.tipo_accion.includes('EXPORTAR')
                  }">
                    {{ accion.tipo_accion }}
                  </span>
                </td>
                <td style="color: #aaa; font-style: italic;">
                  {{ accion.recurso_afectado }} 
                  <small *ngIf="accion.id_recurso_afectado">#{{ accion.id_recurso_afectado }}</small>
                </td>
                <td class="text-truncate" style="max-width: 250px;" [title]="accion.detalles_cambio | json">
                  <small>{{ formatDetalles(accion.detalles_cambio) }}</small>
                </td>
                <td style="font-size: 0.8rem; color: #888;">
                  {{ accion.ip_address }}
                </td>
              </tr>
              
              <tr *ngIf="auditoriaGeneral.length === 0">
                <td colspan="6" class="text-center p-4 text-muted">
                  No hay registros que coincidan con la búsqueda.
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pagination-controls" *ngIf="totalAuditoria > 0">
          <pagination-controls 
            id="pag_auditoria"
            (pageChange)="onPageChangeAuditoria($event)"
            previousLabel="Anterior"
            nextLabel="Siguiente">
          </pagination-controls>
        </div>
      </div>
    </div>
  </div>

</div>

<div *ngIf="modalVisible" class="modal" (click)="cerrarModal()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h5>
        <i class="fas fa-history"></i>
        Historial de Acciones: {{ usuarioSeleccionado }}
      </h5>
      <button (click)="cerrarModal()" type="button" class="btn-close">
        &times;
      </button>
    </div>

    <div class="modal-body">
      <div *ngIf="cargandoModal" class="text-center p-4">
        <div class="spinner-border text-primary"></div>
        <p class="mt-2 text-white">Cargando historial...</p>
      </div>
      
      <div *ngIf="!cargandoModal && historialUsuario.length === 0" class="text-center p-4 text-muted">
        <i class="fas fa-folder-open fa-2x mb-2"></i>
        <h5>Sin acciones</h5>
        <p>No se encontraron acciones recientes.</p>
      </div>

      <div *ngIf="!cargandoModal && historialUsuario.length > 0" class="table-responsive">
        <table class="table-usuarios">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Acción</th>
              <th>Recurso</th>
              <th>Detalles</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let accion of historialUsuario">
              <td class="text-muted">
                <small>{{ accion.timestamp | date:'dd/MM/yy, h:mm:ss a' }}</small>
              </td>
              <td>
                <span class="badge" [ngClass]="{
                    'bg-success': accion.tipo_accion.includes('CREAR'),
                    'bg-warning': accion.tipo_accion.includes('ACTUALIZAR'),
                    'bg-danger': accion.tipo_accion.includes('ELIMINAR'),
                    'bg-secondary': accion.tipo_accion === 'SESION_CERRADA'
                  }">
                  {{ accion.tipo_accion }}
                </span>
              </td>
              <td>
                {{ accion.recurso_afectado }}
                <span *ngIf="accion.id_recurso_afectado" class="text-muted d-block" style="font-size: 0.8em;">
                  (ID: {{ accion.id_recurso_afectado }})
                </span>
              </td>
              <td>
                <small style="display:block; max-width:200px; overflow:hidden; text-overflow:ellipsis;" [title]="accion.detalles_cambio | json">
                    {{ formatDetalles(accion.detalles_cambio) }}
                </small>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="modal-footer">
      <button (click)="cerrarModal()" type="button" class="btn-accion btn-secondary">
        <i class="fas fa-times"></i> Cerrar
      </button>
    </div>
  </div>
</div>