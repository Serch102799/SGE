<div class="usuarios-container">
  <div class="container-header">
    <h2>M√≥dulo de Reportes</h2>
  </div>

  <div class="container-body">
    <div class="report-section">
      <h3>Selecciona un Reporte</h3>
      <p>{{ descripcionReporte }}</p>

      <div class="filtros-container">
        <div class="filtro-item">
          <label for="tipoReporte">Tipo de Reporte</label>
          <select 
            id="tipoReporte" 
            class="form-control" 
            [(ngModel)]="tipoReporteSeleccionado">
            <option value="gastos-totales">Gastos Totales</option>
            <!-- <option value="stock-bajo">Stock Bajo</option> -->
            <!-- <option value="menos-utilizadas">Refacciones Menos Utilizadas</option> -->
            <option value="mas-utilizadas">Refacciones M√°s Utilizadas</option>
            <option value="costo-autobus">Costo por Autob√∫s</option>
            <option value="movimientos-refaccion">Movimientos por Refacci√≥n</option>
            <option value="historial-por-refaccion">Historial por Refacci√≥n</option>
          </select>
        </div>

        <div class="filtro-item" *ngIf="requiereFechas">
          <label for="fechaInicio">Desde:</label>
          <input 
            type="date" 
            id="fechaInicio" 
            class="form-control" 
            [(ngModel)]="fechaInicio">
        </div>

        <div class="filtro-item" *ngIf="requiereFechas">
          <label for="fechaFin">Hasta:</label>
          <input 
            type="date" 
            id="fechaFin" 
            class="form-control" 
            [(ngModel)]="fechaFin">
        </div>
        <div class="buscador-auditoria-container w-100" *ngIf="requiereListaArticulos">
          <hr class="divider">
          <h4 class="auditoria-title"><i class="fas fa-search"></i> Selecciona los art√≠culos a auditar</h4>
          
          <div class="buscadores-grid">
            <div class="filtro-item autocompletar-item">
              <label>Agregar Refacci√≥n:</label>
              <mat-form-field appearance="outline" class="w-100 dark-mat-form">
                <input type="text" matInput placeholder="Escribe para buscar..." 
                       [formControl]="refaccionControl" [matAutocomplete]="autoRef">
                <mat-autocomplete #autoRef="matAutocomplete" [displayWith]="displayFn" 
                                  (optionSelected)="agregarItemLista($event, 'Refacci√≥n')">
                  <mat-option *ngFor="let option of filteredRefacciones$ | async" [value]="option">
                    {{option.nombre}} <small class="text-muted">{{option.marca !== 'N/A' ? '(' + option.marca + ')' : ''}}</small>
                  </mat-option>
                </mat-autocomplete>
              </mat-form-field>
            </div>

            <div class="filtro-item autocompletar-item">
              <label>Agregar Insumo:</label>
              <mat-form-field appearance="outline" class="w-100 dark-mat-form">
                <input type="text" matInput placeholder="Escribe para buscar..." 
                       [formControl]="insumoControl" [matAutocomplete]="autoIns">
                <mat-autocomplete #autoIns="matAutocomplete" [displayWith]="displayFn" 
                                  (optionSelected)="agregarItemLista($event, 'Insumo')">
                  <mat-option *ngFor="let option of filteredInsumos$ | async" [value]="option">
                    {{option.nombre}} <small class="text-muted">{{option.marca !== 'N/A' ? '(' + option.marca + ')' : ''}}</small>
                  </mat-option>
                </mat-autocomplete>
              </mat-form-field>
            </div>
          </div>

          <div class="items-seleccionados-box" *ngIf="itemsSeleccionados.length > 0">
            <div class="item-chip" *ngFor="let item of itemsSeleccionados; let i = index">
              <span class="badge" [ngClass]="item.tipo === 'Refacci√≥n' ? 'badge-refaccion' : 'badge-insumo'">
                {{ item.tipo }}
              </span>
              <span class="item-name">{{ item.nombre }} <small>{{item.marca !== 'N/A' ? '('+item.marca+')' : ''}}</small></span>
              <button class="btn-remove-chip" (click)="eliminarItemLista(i)" title="Quitar de la lista">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          
        </div>
      </div>

      <button class="btn-agregar" (click)="generarReporte()" [disabled]="isLoading">
        <span *ngIf="!isLoading">üìä Generar Reporte</span>
        <span *ngIf="isLoading">‚è≥ Cargando...</span>
      </button>
      
      <p *ngIf="requiereFechas" style="margin-top: 15px; font-size: 0.85rem; color: #999;">
        Nota: El filtro de fecha aplica para este reporte.
      </p>
    </div>

    <div class="results-container" *ngIf="reporteData.length > 0">
      <div class="results-header">
        <h4>{{ tituloReporte }}</h4>
        <div class="export-buttons">
          <button class="btn-exportar" (click)="exportarPDF()">
            üìÑ Exportar a PDF
          </button>
          <button class="btn-excel" (click)="exportarExcel()">
            üìä Exportar a Excel
          </button>
        </div>
      </div>

      <div class="total-general" *ngIf="tipoReporteSeleccionado === 'gastos-totales' && totalGeneral > 0">
        Total General: ${{ totalGeneral | number:'1.2-2':'es-MX' }}
      </div>

      <div class="tabla-responsive-wrapper">
        <table class="tabla-usuarios">
          <thead>
            <tr>
              <th *ngFor="let columna of columnasReporte">
                {{ formatearColumna(columna) }}
              </th>
            </tr>
          </thead>
          <tbody>
            <tr 
              *ngFor="let fila of reporteData"
              [class.alerta-stock-bajo]="fila.stock_actual < fila.stock_minimo">
              
              <td *ngFor="let columna of columnasReporte"
                  [class.stock-critico]="columna === 'stock_actual' && fila.stock_actual < fila.stock_minimo">
                
                <ng-container *ngIf="columna === 'detalles'">
                  <button class="btn-detalles" (click)="abrirModalDetalles(fila)">
                    <i class="fas fa-eye"></i> Ver Desglose
                  </button>
                </ng-container>

                <ng-container *ngIf="columna !== 'detalles'">
                  {{ formatearValor(fila[columna], columna) }}
                </ng-container>
                
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="empty-table-message" *ngIf="reporteData.length === 0 && !isLoading">
      No hay datos para mostrar. Genera un reporte para ver los resultados.
    </div>

    <div class="loading-message" *ngIf="isLoading">
      Generando reporte...
    </div>
  </div>
</div>


<div class="modal-overlay" *ngIf="mostrarModalNotificacion" (click)="cerrarModalNotificacion()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header" [ngClass]="{
      'header-exito': notificacion.tipo === 'exito',
      'header-error': notificacion.tipo === 'error',
      'header-advertencia': notificacion.tipo === 'advertencia'
    }">
      <h3>{{ notificacion.titulo }}</h3>
      <button class="btn-cerrar" (click)="cerrarModalNotificacion()">&times;</button>
    </div>
    <div class="confirm-text">
      {{ notificacion.mensaje }}
    </div>
    <div class="modal-footer">
      <button class="btn-cancelar" (click)="cerrarModalNotificacion()">Cerrar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="modalDetallesVisible" (click)="cerrarModalDetalles()" style="z-index: 2000;">
  <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
    
    <div class="modal-header">
      <h3><i class="fas fa-bus"></i> Desglose de Costos - Bus {{ busSeleccionado?.economico }}</h3>
      <button class="btn-cerrar" (click)="cerrarModalDetalles()">√ó</button>
    </div>
    
    <div class="modal-body">
      <div class="resumen-modal">
        <p><strong>Total de Servicios:</strong> {{ busSeleccionado?.num_servicios }}</p>
        <p><strong>Costo Total:</strong> <span class="text-success">{{ busSeleccionado?.costo_total | currency:'MXN' }}</span></p>
      </div>

      <div class="tabla-responsive-wrapper" style="max-height: 400px; overflow-y: auto;">
        <table class="tabla-detalles">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Art√≠culo</th>
              <th>Marca</th>
              <th style="text-align: right;">Cant.</th>
              <th style="text-align: right;">Costo Unit.</th>
              <th style="text-align: right;">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of busSeleccionado?.detalles">
              <td class="fecha-col">{{ item.fecha | date:'dd/MM/yyyy' }}</td>
              <td>
                <span class="badge" [ngClass]="{'badge-refaccion': item.tipo_item === 'Refacci√≥n', 'badge-insumo': item.tipo_item === 'Insumo'}">
                  {{ item.tipo_item }}
                </span>
              </td>
              <td class="desc-col" [title]="item.nombre">{{ item.nombre }}</td>
              <td>{{ item.marca || 'N/A' }}</td>
              <td style="text-align: right;">{{ item.cantidad | number:'1.0-2' }}</td>
              <td style="text-align: right;">{{ item.costo_unitario | currency:'MXN' }}</td>
              <td style="text-align: right;" class="text-bold">{{ item.costo_total | currency:'MXN' }}</td>
            </tr>
            <tr *ngIf="!busSeleccionado?.detalles?.length">
              <td colspan="7" class="text-center empty-msg">No hay detalles de refacciones o insumos para este autob√∫s.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn-cerrar-modal" (click)="cerrarModalDetalles()">Cerrar</button>
    </div>

  </div>
</div>