<div class="usuarios-container">
  <div class="container-header">
    <h2>Catálogo de Rutas</h2>
    <button class="btn-agregar" (click)="abrirModal('agregar')" *ngIf="authService.hasRole(['Admin', 'SuperUsuario', 'AdminDiesel'])">
      <span>&#43;</span> Agregar Ruta
    </button>
  </div>

  <div class="container-body">
    <div class="filtros-container">
      <div class="filtro-item">
        <input type="text" class="form-control" placeholder="Buscar por nombre de ruta..."
          [(ngModel)]="terminoBusqueda" (ngModelChange)="onSearchChange()">
      </div>
    </div>

    <div class="contador-resultados"><strong>{{ totalItems }}</strong> rutas encontradas</div>

    <div class="tabla-responsive-wrapper">
      <table class="tabla-usuarios">
        <thead>
          <tr>
            <th>Nombre de la Ruta</th>
            <th>Descripción</th>
            <th>KM por Vuelta</th>
            <th>Vueltas/Día</th>
            <th style="text-align: center;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let ruta of rutas | paginate: { itemsPerPage: itemsPerPage, currentPage: currentPage, totalItems: totalItems }">
            <td>{{ ruta.nombre_ruta }}</td>
            <td>{{ ruta.descripcion || '-' }}</td>
            <td>{{ ruta.kilometraje_vuelta | number:'1.0-0' }} km</td>
            <td>{{ ruta.vueltas_diarias_promedio }}</td>
            <td class="acciones" *ngIf="authService.hasRole(['Admin', 'SuperUsuario', 'AdminDiesel'])">
              <button class="btn-accion btn-estado" (click)="abrirModal('editar', ruta)">Editar</button>
              <button class="btn-accion btn-eliminar" (click)="eliminarRuta(ruta.id_ruta)">Eliminar</button>
            </td>
          </tr>
          <tr *ngIf="rutas.length === 0">
            <td colspan="5" class="empty-table-message">No se encontraron rutas.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination-controls">
      <pagination-controls (pageChange)="onPageChange($event)" previousLabel="Anterior" nextLabel="Siguiente"></pagination-controls>
    </div>
  </div>
</div>

<!-- MODAL PARA AGREGAR/EDITAR RUTA -->
<div class="modal-overlay" *ngIf="mostrarModal" (click)="cerrarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ modoEdicion ? 'Editar Ruta' : 'Agregar Nueva Ruta' }}</h3>
      <button class="btn-cerrar" (click)="cerrarModal()">×</button>
    </div>

    <div class="modal-body">
      <form (ngSubmit)="guardarRuta()">
        <div class="form-group">
          <label>Nombre de la Ruta <span class="required">*</span></label>
          <input 
            type="text" 
            class="form-control" 
            [(ngModel)]="rutaSeleccionada.nombre_ruta" 
            name="nombre_ruta" 
            placeholder="Ej: Toxpan - Tuxpan"
            required>
        </div>

        <div class="form-group">
          <label>Descripción</label>
          <textarea 
            class="form-control" 
            [(ngModel)]="rutaSeleccionada.descripcion" 
            name="descripcion" 
            placeholder="Descripción opcional de la ruta"
            rows="3"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Kilometraje por Vuelta <span class="required">*</span></label>
            <input 
              type="number" 
              step="0.1" 
              class="form-control" 
              [(ngModel)]="rutaSeleccionada.kilometraje_vuelta" 
              name="kilometraje_vuelta" 
              placeholder="Ej: 12.5"
              required>
          </div>

          <div class="form-group">
            <label>Vueltas Diarias (Promedio) <span class="required">*</span></label>
            <input 
              type="number" 
              step="1" 
              class="form-control" 
              [(ngModel)]="rutaSeleccionada.vueltas_diarias_promedio" 
              name="vueltas_diarias_promedio" 
              placeholder="Ej: 10"
              required>
          </div>
        </div>

        <div class="info-box">
          <p><strong>Nota:</strong> El "Vueltas Diarias" se utiliza para calcular el kilometraje esperado en modo "Por Días Laborados".</p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn-accion btn-guardar">{{ modoEdicion ? 'Actualizar' : 'Guardar' }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL DE NOTIFICACIÓN -->
<div class="modal-overlay" *ngIf="mostrarModalNotificacion" (click)="cerrarModalNotificacion()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 [ngClass]="{'header-exito': notificacion.tipo === 'exito','header-error': notificacion.tipo === 'error','header-advertencia': notificacion.tipo === 'advertencia'}">
        {{ notificacion.titulo }}
      </h3>
      <button class="btn-cerrar" (click)="cerrarModalNotificacion()">×</button>
    </div>
    <div class="modal-body">
      <p class="confirm-text">{{ notificacion.mensaje }}</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-accion btn-guardar" (click)="cerrarModalNotificacion()">Aceptar</button>
    </div>
  </div>
</div>