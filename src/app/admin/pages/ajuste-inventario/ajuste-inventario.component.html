<div class="contenedor-principal">
  <div class="container-header">
    <div class="titulo-con-regreso">
      <h2>Ajustes de Inventario</h2>
    </div>
    <div class="acciones-header">
      <button class="btn-agregar" (click)="abrirModalCrear()">
        <span>&#43;</span> Nuevo Ajuste
      </button>
    </div>
  </div>

  <div class="container-body">
    
    <div class="filtros-container">
      <div class="filtros-row">
        <div class="filtro-item filtro-busqueda">
          <label>🔍 Buscar:</label>
          <input 
            type="text" 
            class="form-control" 
            placeholder="Buscar por empleado o motivo..."
            [(ngModel)]="terminoBusqueda" 
            (ngModelChange)="onSearchChange()">
        </div>

        <div class="filtro-item">
          <label>Tipo de Ajuste:</label>
          <select class="form-control" [(ngModel)]="filtroTipoAjuste" (change)="onSearchChange()">
            <option value="">Todos</option>
            <option *ngFor="let tipo of tiposAjuste" [value]="tipo.value">{{ tipo.label }}</option>
          </select>
        </div>

        <div class="filtro-item filtro-fecha">
          <label>📅 Desde:</label>
          <input 
            type="date" 
            class="form-control" 
            [(ngModel)]="filtroFechaDesde" 
            (change)="onSearchChange()">
        </div>

        <div class="filtro-item filtro-fecha">
          <label>📅 Hasta:</label>
          <input 
            type="date" 
            class="form-control" 
            [(ngModel)]="filtroFechaHasta" 
            (change)="onSearchChange()">
        </div>
      </div>

      <div class="filtros-row filtros-acciones">
        <button 
          class="btn-limpiar-filtros" 
          (click)="limpiarFiltros()"
          *ngIf="terminoBusqueda || filtroTipoAjuste || filtroFechaDesde || filtroFechaHasta">
          🗑️ Limpiar Filtros
        </button>
      </div>
    </div>

    <div class="contador-resultados">
      <strong>{{ totalItems }}</strong> ajustes encontrados
    </div>

    <div class="tabla-responsive-wrapper">
      <table class="tabla-usuarios">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Empleado</th>
            <th>Tipo</th>
            <th>Motivo</th>
            <th># Detalles</th>
            <th *ngIf="esSuperUsuarioOAdmin()">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let ajuste of ajustes | paginate: { itemsPerPage: itemsPerPage, currentPage: currentPage, totalItems: totalItems }">
            <td>{{ ajuste.id_ajuste }}</td>
            <td>{{ formatearFecha(ajuste.fecha_creacion) }}</td>
            <td>{{ ajuste.nombre_empleado || 'N/A' }}</td>
            <td>
              <span 
                class="badge-tipo-ajuste"
                [ngClass]="obtenerBadgeTipoAjuste(ajuste.tipo_ajuste)">
                {{ ajuste.tipo_ajuste }}
              </span>
            </td>
            <td class="td-motivo">{{ ajuste.motivo }}</td>
            <td>{{ ajuste.total_detalles || 0 }}</td>
            
            <td *ngIf="esSuperUsuarioOAdmin()" class="actions-cell">
              <button 
                (click)="abrirModalEditar(ajuste)" 
                class="btn-icon btn-editar"
                title="Editar Ajuste">
                <i class="fas fa-pencil-alt"></i>
              </button>
            </td>
          </tr>
          
          <tr *ngIf="ajustes.length === 0">
            <td [attr.colspan]="esSuperUsuarioOAdmin() ? 7 : 6" class="empty-table-message">
              No se encontraron ajustes que coincidan con los filtros.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination-controls">
      <pagination-controls 
        (pageChange)="onPageChange($event)" 
        previousLabel="Anterior" 
        nextLabel="Siguiente">
      </pagination-controls>
    </div>
  </div>
</div>

<div *ngIf="modalEditarVisible" 
     class="modal-backdrop-edit" 
     (click)="cerrarModalEditar()">
  
  <div class="modal-content-edit modal-large" (click)="$event.stopPropagation()">
    
    <div class="modal-header-edit">
      <div class="modal-title-container">
        <svg xmlns="http://www.w3.org/2000/svg" class="modal-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
        </svg>
        <h3>{{ ajusteEditando.id_ajuste ? 'Editar' : 'Crear' }} Ajuste de Inventario</h3>
      </div>
      <button class="modal-close-btn-edit" 
              (click)="cerrarModalEditar()" 
              [disabled]="guardandoEdicion"
              title="Cerrar">
        &times;
      </button>
    </div>

    <form (ngSubmit)="guardarAjuste()" #editForm="ngForm">
      
      <div class="modal-body-edit">
        
        <div *ngIf="cargandoEdicion" class="loader-container-edit">
          <div class="spinner-edit"></div>
          <p>Cargando datos del ajuste...</p>
        </div>

        <div *ngIf="!cargandoEdicion">
          
          <div class="info-section-edit" *ngIf="ajusteEditando.id_ajuste">
            <h4>📋 Información del Ajuste</h4>
            <div class="info-grid-edit">
              <div class="info-item-edit">
                <span class="info-label-edit">ID Ajuste:</span>
                <span class="info-value-edit">#{{ ajusteEditando.id_ajuste }}</span>
              </div>
              <div class="info-item-edit">
                <span class="info-label-edit">Fecha Creación:</span>
                <span class="info-value-edit">{{ formatearFecha(ajusteEditando.fecha_creacion) }}</span>
              </div>
            </div>
          </div>

          <div class="seccion-maestro">
            <h4 class="subtitulo-seccion">Datos Generales</h4>

            <div class="form-row-edit">
              <div class="form-group-edit">
                <label for="editEmpleado" class="required-label-edit">
                  👤 Empleado Responsable
                </label>
                <select 
                  id="editEmpleado" 
                  class="form-control-edit"
                  [(ngModel)]="formEdicionMaestro.id_empleado" 
                  name="id_empleado"
                  required>
                  <option [ngValue]="null">-- Seleccione un empleado --</option>
                  <option *ngFor="let emp of empleados" [value]="emp.id_empleado">
                    {{ emp.nombre_completo }}
                  </option>
                </select>
              </div>

              <div class="form-group-edit">
                <label for="editTipoAjuste" class="required-label-edit">
                  📦 Tipo de Ajuste
                </label>
                <select 
                  id="editTipoAjuste" 
                  class="form-control-edit"
                  [(ngModel)]="formEdicionMaestro.tipo_ajuste" 
                  name="tipo_ajuste"
                  required>
                  <option value="">-- Seleccione un tipo --</option>
                  <option *ngFor="let tipo of tiposAjuste" [value]="tipo.value">
                    {{ tipo.label }}
                  </option>
                </select>
              </div>
            </div>

            <div class="form-group-edit">
              <label for="editMotivo" class="required-label-edit">
                📝 Motivo del Ajuste
              </label>
              <textarea 
                id="editMotivo" 
                class="form-control-edit textarea-edit"
                [(ngModel)]="formEdicionMaestro.motivo" 
                name="motivo"
                rows="3"
                placeholder="Describa el motivo del ajuste..."
                required></textarea>
            </div>
          </div>

          <div class="seccion-detalles">
            <div class="header-detalles">
              <h4 class="subtitulo-seccion">Detalles del Ajuste</h4>
              <button 
                type="button" 
                class="btn-agregar-detalle" 
                (click)="agregarDetalle()"
                [disabled]="guardandoEdicion || !formEdicionMaestro.tipo_ajuste">
                <i class="fas fa-plus"></i> Agregar Detalle
              </button>
            </div>

            <div *ngIf="!formEdicionMaestro.tipo_ajuste" class="sin-detalles">
              ⚠️ Seleccione un "Tipo de Ajuste" para agregar detalles.
            </div>

            <div class="lista-detalles" *ngIf="formEdicionMaestro.tipo_ajuste">
              <div 
                *ngFor="let detalle of detallesEdicion; let i = index" 
                class="detalle-card">
                
                <div class="detalle-header">
                  <span class="detalle-numero">Detalle #{{ i + 1 }}</span>
                  <button 
                    type="button" 
                    class="btn-eliminar-detalle" 
                    (click)="eliminarDetalle(i)"
                    [disabled]="guardandoEdicion"
                    title="Eliminar detalle">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>

                <div class="detalle-body">
                  <div class="form-group-edit">
                    <label class="required-label-edit">Tipo de Item:</label>
                    <div class="radio-group">
                      <label class="radio-label">
                        <input 
                          type="radio" 
                          [(ngModel)]="detalle.tipo_item" 
                          [name]="'tipo_item_' + i"
                          value="refaccion"
                          (change)="onTipoItemChange(detalle)">
                        <span>Refacción</span>
                      </label>
                      <label class="radio-label">
                        <input 
                          type="radio" 
                          [(ngModel)]="detalle.tipo_item" 
                          [name]="'tipo_item_' + i"
                          value="insumo"
                          (change)="onTipoItemChange(detalle)">
                        <span>Insumo</span>
                      </label>
                    </div>
                  </div>

                  <div class="form-row-edit">
                    <div class="form-group-edit" *ngIf="detalle.tipo_item === 'refaccion'">
                      <label class="required-label-edit">Refacción:</label>
                      <select 
                        class="form-control-edit"
                        [(ngModel)]="detalle.id_refaccion" 
                        [name]="'refaccion_' + i"
                        (change)="onRefaccionChange(detalle)"
                        required>
                        <option [ngValue]="null">-- Seleccione --</option>
                        <option *ngFor="let ref of refacciones" [value]="ref.id_refaccion">
                          {{ ref.nombre_refaccion }}
                        </option>
                      </select>
                    </div>

                    <div class="form-group-edit" *ngIf="detalle.tipo_item === 'insumo'">
                      <label class="required-label-edit">Insumo:</label>
                      <select 
                        class="form-control-edit"
                        [(ngModel)]="detalle.id_insumo" 
                        [name]="'insumo_' + i"
                        required>
                        <option [ngValue]="null">-- Seleccione --</option>
                        <option *ngFor="let ins of insumos" [value]="ins.id_insumo">
                          {{ ins.nombre_insumo }} (Stock: {{ ins.stock_actual }})
                        </option>
                      </select>
                    </div>

                    <div class="form-group-edit" 
                         *ngIf="detalle.tipo_item === 'refaccion'">
                      <label [class.required-label-edit]="formEdicionMaestro.tipo_ajuste === 'SALIDA' || formEdicionMaestro.tipo_ajuste === 'REVALORIZACION'">Lote:</label>
                      <select 
                        class="form-control-edit"
                        [(ngModel)]="detalle.id_lote" 
                        [name]="'lote_' + i"
                        [disabled]="esCampoDetalleDeshabilitado(detalle, 'lote')"
                        [required]="formEdicionMaestro.tipo_ajuste === 'SALIDA' || formEdicionMaestro.tipo_ajuste === 'REVALORIZACION'">
                        <option [ngValue]="null">-- Seleccione --</option>
                        <option *ngFor="let lote of lotesDisponibles" [value]="lote.id_lote_refaccion">
                          Lote #{{ lote.id_lote_refaccion }} (Disp: {{ lote.cantidad_disponible }} | Costo: {{ lote.costo_unitario_final | currency }})
                        </option>
                      </select>
                    </div>
                  </div>

                  <div class="form-row-edit">
                    <div class="form-group-edit">
                      <label class="required-label-edit">Cantidad:</label>
                      <input 
                        type="number" 
                        class="form-control-edit"
                        [(ngModel)]="detalle.cantidad" 
                        [name]="'cantidad_' + i"
                        step="any"
                        [disabled]="esCampoDetalleDeshabilitado(detalle, 'cantidad')"
                        required>
                      <small class="form-hint-edit" *ngIf="formEdicionMaestro.tipo_ajuste === 'ENTRADA'">
                        Valor positivo (ej: 10)
                      </small>
                      <small class="form-hint-edit" *ngIf="formEdicionMaestro.tipo_ajuste === 'SALIDA'">
                        Valor negativo (ej: -10)
                      </small>
                      <small class="form-hint-edit" *ngIf="formEdicionMaestro.tipo_ajuste === 'REVALORIZACION'">
                        Debe ser 0 (solo se ajusta el costo)
                      </small>
                    </div>

                    <div class="form-group-edit">
                      <label>Costo Ajuste:</label>
                      <input 
                        type="number" 
                        class="form-control-edit"
                        [(ngModel)]="detalle.costo_ajuste" 
                        [name]="'costo_' + i"
                        step="0.01"
                        min="0"
                        [disabled]="esCampoDetalleDeshabilitado(detalle, 'costo')">
                      <small class="form-hint-edit" *ngIf="formEdicionMaestro.tipo_ajuste === 'ENTRADA'">
                        Costo unitario del nuevo ítem
                      </small>
                      <small class="form-hint-edit" *ngIf="formEdicionMaestro.tipo_ajuste === 'REVALORIZACION'">
                        Valor a sumar/restar al costo (ej: 20 o -20)
                      </small>
                      <small class="form-hint-edit" *ngIf="formEdicionMaestro.tipo_ajuste === 'SALIDA'">
                        (Costo no aplica en Salida)
                      </small>
                    </div>
                  </div>
                </div>
              </div>

              <div *ngIf="detallesEdicion.length === 0" class="sin-detalles">
                ⚠️ No hay detalles. Agregue al menos uno para continuar.
              </div>
            </div>
          </div>

          <div *ngIf="ajusteEditando.id_ajuste && detectarCambios()" class="changes-summary-edit">
            <h4>⚠️ Cambios Detectados</h4>
            <div class="recalc-notice-edit">
              <svg xmlns="http://www.w3.org/2000/svg" class="notice-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <strong>⚠️ Se actualizará el inventario automáticamente según los cambios</strong>
            </div>
          </div>

          <div *ngIf="ajusteEditando.id_ajuste && !detectarCambios() && !cargandoEdicion" class="no-changes-edit">
            ℹ️ No se han realizado cambios
          </div>

        </div>
      </div>

      <div class="modal-footer-edit">
        <button 
          type="button" 
          class="btn-edit btn-secondary-edit" 
          (click)="cerrarModalEditar()" 
          [disabled]="guardandoEdicion">
          <svg xmlns="http://www.w3.org/2000/svg" class="btn-icon-edit" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          Cancelar
        </button>
        
        <button 
          type="submit" 
          class="btn-edit btn-primary-edit"
          [disabled]="!editForm.form.valid || guardandoEdicion || (ajusteEditando.id_ajuste && !detectarCambios())">
          
          <svg *ngIf="!guardandoEdicion" xmlns="http://www.w3.org/2000/svg" class="btn-icon-edit" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          <div *ngIf="guardandoEdicion" class="spinner-small-edit"></div>
          
          <span>{{ guardandoEdicion ? 'Guardando...' : (ajusteEditando.id_ajuste ? 'Guardar Cambios' : 'Crear Ajuste') }}</span>
        </button>
      </div>

    </form>

  </div>
</div>


<div *ngIf="mostrarModalNotificacion" class="modal-backdrop-notificacion">
  <div class="modal-contenido-notificacion" [ngClass]="'modal-' + notificacion.tipo">
    
    <div class="modal-header-notificacion">
      <h3 class="modal-titulo-notificacion">
        <i *ngIf="notificacion.tipo === 'exito'" class="fas fa-check-circle"></i>
        <i *ngIf="notificacion.tipo === 'error'" class="fas fa-times-circle"></i>
        <i *ngIf="notificacion.tipo === 'advertencia'" class="fas fa-exclamation-triangle"></i>
        {{ notificacion.titulo }}
      </h3>
      <button (click)="cerrarModalNotificacion()" class="btn-cerrar-notificacion">&times;</button>
    </div>
    
    <div class="modal-body-notificacion">
      <p>{{ notificacion.mensaje }}</p>
    </div>
    
    <div class="modal-footer-notificacion">
      <button (click)="cerrarModalNotificacion()" class="btn-notificacion-ok" [ngClass]="'btn-' + notificacion.tipo">
        Entendido
      </button>
    </div>

  </div>
</div>