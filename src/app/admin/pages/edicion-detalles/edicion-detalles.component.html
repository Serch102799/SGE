<div class="usuarios-container">
  <div class="container-header">
    <h2>SuperAdmin: Edición de Detalles de Entrada</h2>
  </div>
  <div class="container-body">
    <div class="filtros-container">
      <input type="text" class="form-control" placeholder="Buscar por nombre de item..."
        [(ngModel)]="terminoBusqueda" (ngModelChange)="onSearchChange()">
    </div>
    <div class="contador-resultados"><strong>{{ totalItems }}</strong> items encontrados</div>
    <div class="tabla-responsive-wrapper">
      <table class="tabla-usuarios">
        <thead>
          <tr>
            <th>Fecha Oper.</th>
            <th>Tipo</th>
            <th>Descripción</th>
            <th>Cantidad</th>
            <th>Costo Unitario</th>
            <th>Costo Neto</th>
            <th style="text-align: center;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let detalle of detalles | paginate: { itemsPerPage: itemsPerPage, currentPage: currentPage, totalItems: totalItems }">
            <td>{{ detalle.fecha_operacion | date:'dd/MM/yy' }}</td>
            <td>
              <span class="badge" [ngClass]="{'badge-refaccion': detalle.tipo === 'refaccion', 'badge-insumo': detalle.tipo === 'insumo'}">
                {{ detalle.tipo }}
              </span>
            </td>
            <td>{{ detalle.nombre_item }}</td>
            <td>{{ detalle.cantidad_recibida | number:'1.2-2' }}</td>
            <td>{{ detalle.costo | currency:'MXN' }}</td>
            <td><strong>{{ (detalle.cantidad_recibida * detalle.costo) | currency:'MXN' }}</strong></td>
            <td class="acciones">
              <button class="btn-accion btn-estado" (click)="abrirModalEditar(detalle)">Editar</button>
              </td>
          </tr>
          <tr *ngIf="detalles.length === 0">
            <td colspan="7" class="empty-table-message">No se encontraron detalles de entrada.</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="pagination-controls">
      <pagination-controls (pageChange)="onPageChange($event)" previousLabel="Anterior" nextLabel="Siguiente"></pagination-controls>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalEditar" (click)="cerrarModalEditar()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3 *ngIf="detalleAEditar">Editando Detalle #{{ detalleAEditar.id_detalle }} ({{ detalleAEditar.tipo }})</h3>
            <button class="btn-cerrar" (click)="cerrarModalEditar()">×</button>
        </div>
        <div class="modal-body">
            <form (ngSubmit)="guardarCambios()">
                <p class="item-info" *ngIf="detalleAEditar"><strong>Item:</strong> {{ detalleAEditar.nombre_item }}</p>
                <div class="form-row">
                    <div class="form-group col">
                        <label>Cantidad Recibida</label>
                        <input type="number" step="0.01" class="form-control" [(ngModel)]="nuevosDatos.cantidad_recibida" name="cantidad_recibida" required>
                    </div>
                    <div class="form-group col">
                        <label>Costo Unitario Final ($)</label>
                        <input type="number" step="0.01" class="form-control" [(ngModel)]="nuevosDatos.costo" name="costo" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="motivo">Motivo de la Modificación (Obligatorio)</label>
                    <textarea id="motivo" class="form-control" [(ngModel)]="nuevosDatos.motivo" name="motivo" rows="3" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-accion btn-cancelar" (click)="cerrarModalEditar()">Cancelar</button>
                    <button type="submit" class="btn-accion btn-guardar" [disabled]="isSaving || !nuevosDatos.motivo.trim()">
                        {{ isSaving ? 'Guardando...' : 'Guardar Cambios' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalNotificacion" (click)="cerrarModalNotificacion()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 [ngClass]="{
        'header-exito': notificacion.tipo === 'exito',
        'header-error': notificacion.tipo === 'error',
        'header-advertencia': notificacion.tipo === 'advertencia'
      }">
        {{ notificacion.titulo }}
      </h3>
      <button class="btn-cerrar" (click)="cerrarModalNotificacion()">×</button>
    </div>
    <div class="modal-body">
      <p class="confirm-text">{{ notificacion.mensaje }}</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-accion btn-guardar" (click)="cerrarModalNotificacion()">Aceptar</button>
    </div>
  </div>
</div>