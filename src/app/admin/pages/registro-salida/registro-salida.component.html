<div class="back-arrow" (click)="regresar()">&#8592;</div>

<div class="form-container">
  <div class="container-header">
    <h2>Registrar Nuevo Vale de Salida</h2>
  </div>

  <div class="container-body">

    <fieldset class="form-section">
      <legend>1. Datos del Vale de Salida</legend>
      <div class="form-row">
        <div class="form-group col">
          <label for="fecha_operacion">Fecha de Operación</label>
          <input id="fecha_operacion" type="datetime-local" class="form-control" 
                 [(ngModel)]="salidaMaestro.fecha_operacion" name="fecha_operacion"
                 [max]="getFormattedCurrentDateTime()" 
                 required>
        </div>
        <div class="form-group col">
          <label for="tipoSalida">Tipo de Salida</label>
          <select id="tipoSalida" class="form-control" [(ngModel)]="salidaMaestro.tipoSalida" name="tipoSalida">
            <option value="Mantenimiento Correctivo">Mantenimiento Correctivo</option>
            <option value="Mantenimiento Preventivo">Mantenimiento Preventivo</option>
            <option value="Venta">Venta</option>
            <option value="Emergencia">Emergencia</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        
        <div class="form-group col">
          <label for="autobus-input">Buscar Autobús</label>
          <mat-form-field appearance="outline" class="full-width">
            <input 
              type="text" 
              id="autobus-input"
              placeholder="Escribe para buscar..." 
              matInput 
              [formControl]="autobusControl" 
              [matAutocomplete]="autoAutobus"
              required>
          </mat-form-field>
          <mat-autocomplete #autoAutobus="matAutocomplete" [displayWith]="displayFn" (optionSelected)="onAutobusSelected($event)">
            <mat-option *ngFor="let autobus of filteredAutobuses$ | async" [value]="autobus">
              {{ autobus.economico }}
            </mat-option>
          </mat-autocomplete>
        </div>

      </div>
      <div class="form-row">
        <div class="form-group col">
          <label for="kilometraje">Kilometraje del Autobús</label>
          <input id="kilometraje" type="number" class="form-control" [(ngModel)]="salidaMaestro.kilometraje" name="kilometraje" required>
        </div>
        <div class="form-group col">
          <label for="empleado">Solicitado Por</label>
          <select id="empleado" class="form-control" [(ngModel)]="salidaMaestro.solicitadoPorID" name="solicitadoPorID" required>
            <option [ngValue]="null" disabled>Selecciona un empleado...</option>
            <option *ngFor="let e of empleados" [ngValue]="e.id_empleado">{{ e.nombre }}</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label for="observaciones">Observaciones</label>
        <textarea id="observaciones" class="form-control" [(ngModel)]="salidaMaestro.observaciones" name="observaciones" rows="2"></textarea>
      </div>
    </fieldset>

    <fieldset class="form-section">
      <legend>2. Agregar Refacciones</legend>
      <div class="form-row align-items-end">
        <div class="form-group col-md-5">
          <label for="refaccion-input">Buscar Refacción</label>
          <mat-form-field appearance="outline" class="full-width">
            <input 
              type="text" 
              id="refaccion-input"
              placeholder="Escribe para buscar..." 
              matInput 
              [formControl]="refaccionControl" 
              [matAutocomplete]="autoRefaccion">
          </mat-form-field>
          <mat-autocomplete #autoRefaccion="matAutocomplete" [displayWith]="displayFn" (optionSelected)="onRefaccionSelected($event)">
            <mat-option *ngFor="let refaccion of filteredRefacciones$ | async" [value]="refaccion">
              {{ refaccion.nombre }} ({{ refaccion.numero_parte || 'S/N' }})
            </mat-option>
          </mat-autocomplete>
        </div>
        <div class="form-group col-md-3">
          <label>Lote</label>
          <select class="form-control" [(ngModel)]="detalleActualRefaccion.id_lote" name="id_lote">
            <option [ngValue]="null" disabled>Selecciona un lote...</option>
            <option *ngFor="let lote of lotesDisponibles" [ngValue]="lote.id_lote">
              {{ lote.nombre_proveedor }} (Disp: {{ lote.cantidad_disponible }})
            </option>
          </select>
        </div>
        <div class="form-group col-md-2">
          <label>Cantidad</label>
          <input type="number" class="form-control" [(ngModel)]="detalleActualRefaccion.cantidad_despachada" name="cantidad_despachada" min="1">
        </div>
        <div class="form-group-button">
          <button type="button" class="btn-agregar-detalle" (click)="agregarDetalleRefaccion()">Agregar</button>
        </div>
      </div>
      <table class="tabla-preview" *ngIf="detallesRefaccionesAAgregar.length > 0">
        <thead>
          <tr>
            <th>Refacción</th>
            <th>Proveedor (Lote)</th>
            <th>Cantidad</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let detalle of detallesRefaccionesAAgregar; let i = index">
            <td>{{ detalle.nombre_refaccion }}</td>
            <td>{{ detalle.nombre_proveedor }}</td>
            <td>{{ detalle.cantidad_despachada }}</td>
            <td class="acciones"><button type="button" class="btn-accion btn-eliminar-sm" (click)="eliminarDetalleRefaccion(i)">Quitar</button></td>
          </tr>
        </tbody>
      </table>
    </fieldset>

    <fieldset class="form-section">
      <legend>3. Agregar Insumos</legend>
      <div class="form-row align-items-end">
        <div class="form-group col-md-8">
          <label for="insumo-input">Buscar Insumo</label>
          <mat-form-field appearance="outline" class="full-width">
            <input 
              type="text" 
              id="insumo-input"
              placeholder="Escribe para buscar..." 
              matInput 
              [formControl]="insumoControl" 
              [matAutocomplete]="autoInsumo">
          </mat-form-field>
          <mat-autocomplete #autoInsumo="matAutocomplete" [displayWith]="displayFn" (optionSelected)="onInsumoSelected($event)">
            <mat-option *ngFor="let insumo of filteredInsumos$ | async" [value]="insumo">
              {{ insumo.nombre }} (Stock: {{ insumo.stock_actual }})
            </mat-option>
          </mat-autocomplete>
        </div>
        <div class="form-group col-md-2">
          <label>Cantidad</label>
          <input type="number" step="0.01" class="form-control" [(ngModel)]="detalleActualInsumo.cantidad_usada" name="cantidad_usada" min="0.01">
        </div>
        <div class="form-group-button">
          <button type="button" class="btn-agregar-detalle" (click)="agregarDetalleInsumo()">Agregar</button>
        </div>
      </div>
      <table class="tabla-preview" *ngIf="detallesInsumosAAgregar.length > 0">
        <thead>
          <tr>
            <th>Insumo</th>
            <th>Cantidad</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let detalle of detallesInsumosAAgregar; let i = index">
            <td>{{ detalle.nombre_insumo }}</td>
            <td>{{ detalle.cantidad_usada }}</td>
            <td class="acciones"><button type="button" class="btn-accion btn-eliminar-sm" (click)="eliminarDetalleInsumo(i)">Quitar</button></td>
          </tr>
        </tbody>
      </table>
    </fieldset>

    <div class="acciones-finales">
      <button type="button" class="btn-accion btn-cancelar" (click)="regresar()" [disabled]="isSaving">Cancelar</button>
      <button type="button" class="btn-accion btn-guardar" (click)="guardarSalidaCompleta()" [disabled]="isSaving">
        {{ isSaving ? 'Guardando...' : 'Guardar Vale de Salida' }}
      </button>
    </div>

  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalNotificacion" (click)="cerrarModalNotificacion()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 [ngClass]="{
        'header-exito': notificacion.tipo === 'exito',
        'header-error': notificacion.tipo === 'error',
        'header-advertencia': notificacion.tipo === 'advertencia'
      }">
        {{ notificacion.titulo }}
      </h3>
      <button class="btn-cerrar" (click)="cerrarModalNotificacion()">×</button>
    </div>
    <div class="modal-body">
      <p class="confirm-text">{{ notificacion.mensaje }}</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-accion btn-guardar" (click)="cerrarModalNotificacion()">Aceptar</button>
    </div>
  </div>
</div>