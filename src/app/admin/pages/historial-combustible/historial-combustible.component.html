<div class="usuarios-container">
  <div class="container-header">
    <h2>Historial de Cargas de Combustible</h2>
    <div class="acciones-header">
      <button 
        class="btn-exportar btn-exportar-excel" 
        (click)="exportarAExcel()"
        [disabled]="exportandoExcel || totalItems === 0"
        title="Descargar TODOS los datos filtrados en formato Excel">
        <span *ngIf="!exportandoExcel">📊 Exportar Excel ({{ totalItems }} registros)</span>
        <span *ngIf="exportandoExcel">⏳ Generando Excel...</span>
      </button>
      <button 
        class="btn-exportar btn-exportar-pdf" 
        (click)="exportarAPDF()"
        [disabled]="exportando || totalItems === 0"
        title="Descargar TODOS los datos filtrados en formato PDF">
        <span *ngIf="!exportando">📄 Exportar PDF ({{ totalItems }} registros)</span>
        <span *ngIf="exportando">⏳ Generando PDF...</span>
      </button>
      <a routerLink="/admin/registro-carga-combustible" class="btn-agregar">
        <span>&#43;</span> Registrar Nueva Carga
      </a>
    </div>
  </div>

  <div class="container-body">
    <!-- Selector de Tipo de Cálculo -->
    <div class="tipo-calculo-selector">
      <div class="selector-label">Tipo de cálculo:</div>
      <div class="selector-buttons">
        <button 
          (click)="cambiarTipoCalculo('vueltas')"
          [class.active]="tipoCalculo === 'vueltas'"
          class="btn-tipo-calculo">
          📍 Por Vueltas
        </button>
        <button 
          (click)="cambiarTipoCalculo('dias')"
          [class.active]="tipoCalculo === 'dias'"
          class="btn-tipo-calculo">
          📅 Por Días
        </button>
      </div>
    </div>

    <!-- FILTROS AVANZADOS -->
    <div class="filtros-container">
      <!-- Fila 1: Búsqueda y Fechas -->
      <div class="filtros-row">
        <div class="filtro-item filtro-busqueda">
          <label>🔍 Buscar:</label>
          <input 
            type="text" 
            class="form-control" 
            placeholder="Económico u operador..."
            [(ngModel)]="terminoBusqueda" 
            (ngModelChange)="onSearchChange()">
        </div>

        <div class="filtro-item filtro-fecha">
          <label>📅 Desde:</label>
          <input 
            type="date" 
            class="form-control" 
            [(ngModel)]="filtroFechaDesde" 
            (change)="onFechaChange()">
        </div>

        <div class="filtro-item filtro-fecha">
          <label>📅 Hasta:</label>
          <input 
            type="date" 
            class="form-control" 
            [(ngModel)]="filtroFechaHasta" 
            (change)="onFechaChange()">
        </div>
      </div>

      <!-- Fila 2: Selección de Rutas (solo en modo vueltas) -->
      <div class="filtros-row" *ngIf="tipoCalculo === 'vueltas'">
        <div class="filtro-item filtro-rutas-multiple">
          <label>🛣️ Filtrar por Rutas:</label>
          <div class="rutas-checkboxes-container">
            <div class="ruta-checkbox" *ngFor="let ruta of rutas">
              <label>
                <input 
                  type="checkbox" 
                  [checked]="isRutaSeleccionada(ruta.id_ruta)"
                  (change)="onRutaToggle(ruta.id_ruta, $event)">
                <span>{{ ruta.nombre_ruta }}</span>
              </label>
            </div>
            <small class="rutas-hint" *ngIf="filtroRutasIds.length > 0">
              {{ filtroRutasIds.length }} ruta(s) seleccionada(s)
            </small>
          </div>
        </div>
      </div>

      <!-- Botón Limpiar Filtros -->
      <div class="filtros-row filtros-acciones">
        <button 
          class="btn-limpiar-filtros" 
          (click)="limpiarFiltros()"
          *ngIf="terminoBusqueda || filtroRutasIds.length > 0 || filtroFechaDesde || filtroFechaHasta">
          🗑️ Limpiar Filtros
        </button>
      </div>
    </div>

    <!-- Resumen de Filtros Aplicados -->
    <div class="resumen-filtros" *ngIf="filtroFechaDesde || filtroFechaHasta || filtroRutasIds.length > 0">
      <strong>Filtros activos:</strong>
      <span class="badge-filtro" *ngIf="filtroFechaDesde">
        Desde: {{ filtroFechaDesde | date:'dd/MM/yyyy' }}
      </span>
      <span class="badge-filtro" *ngIf="filtroFechaHasta">
        Hasta: {{ filtroFechaHasta | date:'dd/MM/yyyy' }}
      </span>
      <span class="badge-filtro" *ngIf="filtroRutasIds.length > 0">
        {{ filtroRutasIds.length }} ruta(s) seleccionada(s)
      </span>
    </div>

    <!-- Contador de Resultados -->
    <div class="contador-resultados">
      <strong>{{ totalItems }}</strong> cargas encontradas
      <span class="tipo-calculo-badge">
        {{ tipoCalculo === 'vueltas' ? '(Por Vueltas)' : '(Por Días)' }}
      </span>
    </div>

    <!-- Tabla de Resultados -->
    <div class="tabla-responsive-wrapper">
      <table class="tabla-usuarios">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Autobús</th>
            <th>Operador</th>
            <th>KM Inicial</th> 
            <th>KM Final</th>
            <th>KM Recorridos</th>
            <th>Litros</th>
            <th>Rendimiento</th>
            <!-- <th>Calificación</th> -->
            <th *ngIf="tipoCalculo === 'vueltas'">Rutas y Vueltas</th>
            <th *ngIf="tipoCalculo === 'dias'">Ruta Principal</th>
            <th>Despachador</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let carga of cargas | paginate: { itemsPerPage: itemsPerPage, currentPage: currentPage, totalItems: totalItems }">
            <td>{{ carga.fecha_operacion | date:'dd/MM/yy h:mm a' }}</td>
            <td>{{ carga.economico }}</td>
            <td>{{ carga.nombre_operador }}</td>
            <td>{{ carga.km_inicial | number }} km</td> 
            <td>{{ carga.km_final | number }} km</td>
            <td>{{ carga.km_recorridos | number }} km</td>
            <td>{{ carga.litros_cargados | number:'1.2-2' }} Lts</td>
            <td>
              <span [ngClass]="{'alerta-rendimiento': carga.alerta_rendimiento}">
                {{ carga.rendimiento_calculado | number:'1.2-2' }}
              </span>
            </td>
            <!-- NUEVA COLUMNA: Calificación -->
            <!-- <td>
              <span 
                class="badge-clasificacion"
                [ngClass]="{
                  'clasificacion-excelente': carga.clasificacion_rendimiento === 'Excelente',
                  'clasificacion-bueno': carga.clasificacion_rendimiento === 'Bueno',
                  'clasificacion-regular': carga.clasificacion_rendimiento === 'Regular',
                  'clasificacion-malo': carga.clasificacion_rendimiento === 'Malo'
                }">
                {{ carga.clasificacion_rendimiento || '-' }}
              </span>
            </td> -->
            <td *ngIf="tipoCalculo === 'vueltas'">
              {{ carga.rutas_y_vueltas || '-' }}
            </td>
            <td *ngIf="tipoCalculo === 'dias'">
              {{ carga.rutas_y_vueltas || '-' }}
            </td>
            <td>{{ carga.nombre_despachador }}</td>
          </tr>
          <tr *ngIf="cargas.length === 0">
            <td [attr.colspan]="tipoCalculo === 'vueltas' ? 11 : 11" class="empty-table-message">
              No se encontraron cargas que coincidan con los filtros.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="pagination-controls">
      <pagination-controls 
        (pageChange)="onPageChange($event)" 
        previousLabel="Anterior" 
        nextLabel="Siguiente">
      </pagination-controls>
    </div>
  </div>
</div>