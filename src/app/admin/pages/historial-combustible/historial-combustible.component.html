<div class="usuarios-container">
  <div class="container-header">
    <h2>Historial de Cargas de Combustible</h2>
    <div class="acciones-header">
      <button 
        class="btn-exportar btn-exportar-excel" 
        (click)="exportarAExcel()"
        [disabled]="exportandoExcel || totalItems === 0"
        title="Descargar TODOS los datos filtrados en formato Excel">
        <span *ngIf="!exportandoExcel">üìä Exportar Excel ({{ totalItems }} registros)</span>
        <span *ngIf="exportandoExcel">‚è≥ Generando Excel...</span>
      </button>
      <button 
        class="btn-exportar btn-exportar-pdf" 
        (click)="exportarAPDF()"
        [disabled]="exportando || totalItems === 0"
        title="Descargar TODOS los datos filtrados en formato PDF">
        <span *ngIf="!exportando">üìÑ Exportar PDF ({{ totalItems }} registros)</span>
        <span *ngIf="exportando">‚è≥ Generando PDF...</span>
      </button>
      <a routerLink="/admin/registro-carga-combustible" class="btn-agregar">
        <span>&#43;</span> Registrar Nueva Carga
      </a>
    </div>
  </div>

  <div class="container-body">
    <div class="tipo-calculo-selector">
      <div class="selector-label">Tipo de c√°lculo:</div>
      <div class="selector-buttons">
        <button 
          (click)="cambiarTipoCalculo('vueltas')"
          [class.active]="tipoCalculo === 'vueltas'"
          class="btn-tipo-calculo">
          üìç Por Vueltas
        </button>
        <button 
          (click)="cambiarTipoCalculo('dias')"
          [class.active]="tipoCalculo === 'dias'"
          class="btn-tipo-calculo">
          üìÖ Por D√≠as
        </button>
      </div>
    </div>

    <div class="filtros-container">
      <div class="filtros-row">
        <div class="filtro-item filtro-busqueda">
          <label>üîç Buscar:</label>
          <input 
            type="text" 
            class="form-control" 
            placeholder="Econ√≥mico u operador..."
            [(ngModel)]="terminoBusqueda" 
            (ngModelChange)="onSearchChange()">
        </div>

        <div class="filtro-item filtro-fecha">
          <label>üìÖ Desde:</label>
          <input 
            type="date" 
            class="form-control" 
            [(ngModel)]="filtroFechaDesde" 
            (change)="onFechaChange()">
        </div>

        <div class="filtro-item filtro-fecha">
          <label>üìÖ Hasta:</label>
          <input 
            type="date" 
            class="form-control" 
            [(ngModel)]="filtroFechaHasta" 
            (change)="onFechaChange()">
        </div>
      </div>

      <div class="filtros-row" *ngIf="tipoCalculo === 'vueltas'">
        <div class="filtro-item filtro-rutas-multiple">
          <div class="dropdown-rutas-header" (click)="toggleRutasDropdown()">
            <label>üõ£Ô∏è Filtrar por Rutas:</label>
            <div class="dropdown-info">
              <span class="rutas-count" *ngIf="filtroRutasIds.length > 0">
                {{ filtroRutasIds.length }} seleccionada(s)
              </span>
              <span class="dropdown-arrow" [class.rotated]="rutasDropdownOpen">
                ‚ñº
              </span>
            </div>
          </div>
          
          <div class="rutas-checkboxes-container" 
                [class.open]="rutasDropdownOpen"
                [@slideDown]="rutasDropdownOpen ? 'open' : 'closed'">
            <div class="ruta-checkbox" *ngFor="let ruta of rutas">
              <label>
                <input 
                  type="checkbox" 
                  [checked]="isRutaSeleccionada(ruta.id_ruta)"
                  (change)="onRutaToggle(ruta.id_ruta, $event)">
                <span>{{ ruta.nombre_ruta }}</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="filtros-row filtros-acciones">
        <button 
          class="btn-limpiar-filtros" 
          (click)="limpiarFiltros()"
          *ngIf="terminoBusqueda || filtroRutasIds.length > 0 || filtroFechaDesde || filtroFechaHasta">
          üóëÔ∏è Limpiar Filtros
        </button>
      </div>
    </div>

    <div class="resumen-filtros" *ngIf="filtroFechaDesde || filtroFechaHasta || filtroRutasIds.length > 0">
      <strong>Filtros activos:</strong>
      <span class="badge-filtro" *ngIf="filtroFechaDesde">
        Desde: {{ filtroFechaDesde | date:'dd/MM/yyyy' }}
      </span>
      <span class="badge-filtro" *ngIf="filtroFechaHasta">
        Hasta: {{ filtroFechaHasta | date:'dd/MM/yyyy' }}
      </span>
      <span class="badge-filtro" *ngIf="filtroRutasIds.length > 0">
        {{ filtroRutasIds.length }} ruta(s) seleccionada(s)
      </span>
    </div>

    <div class="contador-resultados">
      <strong>{{ totalItems }}</strong> cargas encontradas
      <span class="tipo-calculo-badge">
        {{ tipoCalculo === 'vueltas' ? '(Por Vueltas)' : '(Por D√≠as)' }}
      </span>
    </div>

    <div class="tabla-responsive-wrapper">
      <table class="tabla-usuarios">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Autob√∫s</th>
            <th>Operador</th>
            <th>KM Inicial</th> 
            <th>KM Final</th>
            <th>KM Recorridos</th>
            <th>Litros</th>
            <th>Rendimiento</th>
            <th>Estatus</th>
            <th *ngIf="tipoCalculo === 'vueltas'">Rutas y Vueltas</th>
            <th *ngIf="tipoCalculo === 'dias'">Ruta Principal</th>
            <th>Despachador</th>
            <th *ngIf="authService.hasRole(['SuperUsuario'])">Editar</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let carga of cargas | paginate: { itemsPerPage: itemsPerPage, currentPage: currentPage, totalItems: totalItems }">
            <td>{{ carga.fecha_operacion | date:'dd/MM/yy h:mm a' }}</td>
            <td>{{ carga.economico }}</td>
            <td>{{ carga.nombre_operador }}</td>
            <td>{{ carga.km_inicial | number }} km</td> 
            <td>{{ carga.km_final | number }} km</td>
            <td>{{ carga.km_recorridos | number }} km</td>
            <td>{{ carga.litros_cargados | number:'1.2-2' }} Lts</td>
            <td>
              <span [ngClass]="{'alerta-rendimiento': carga.alerta_rendimiento}">
                {{ carga.rendimiento_calculado | number:'1.2-2' }}
              </span>
            </td>
            <td>
              <span 
                class="badge-clasificacion"
                [ngClass]="{
                  'clasificacion-excelente': carga.clasificacion_rendimiento === 'Excelente',
                  'clasificacion-bueno': carga.clasificacion_rendimiento === 'Bueno',
                  'clasificacion-regular': carga.clasificacion_rendimiento === 'Regular',
                  'clasificacion-malo': carga.clasificacion_rendimiento === 'Malo'
                }">
                {{ carga.clasificacion_rendimiento || '-' }}
              </span>
            </td>
            <td *ngIf="tipoCalculo === 'vueltas'">
              {{ carga.rutas_y_vueltas || '-' }}
            </td>
            <td *ngIf="tipoCalculo === 'dias'">
              {{ carga.rutas_y_vueltas || '-' }}
            </td>
            <td>{{ carga.nombre_despachador }}</td>
            
            <td *ngIf="authService.hasRole(['SuperUsuario'])" class="actions-cell">
              <button (click)="abrirModalEditar(carga)" 
                      class="btn-icon btn-editar"
                      title="Editar Carga">
                <i class="fas fa-pencil-alt">Editar</i>
              </button>
            </td>
          </tr>
          
          <tr *ngIf="cargas.length === 0">
            <td [attr.colspan]="authService.hasRole(['SuperUsuario']) ? 12 : 11" class="empty-table-message">
              No se encontraron cargas que coincidan con los filtros.
            </td>
            </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination-controls">
      <pagination-controls 
        (pageChange)="onPageChange($event)" 
        previousLabel="Anterior" 
        nextLabel="Siguiente">
      </pagination-controls>
    </div>
  </div>
</div>

<div *ngIf="modalEditarVisible && authService.hasRole(['SuperUsuario'])" class="modal-backdrop-edit" (click)="cerrarModalEditar()">
  
  <div class="modal-content-edit" (click)="$event.stopPropagation()">
    
    <div class="modal-header-edit">
      <h3>Editar Carga de Combustible</h3>
      <button class="modal-close-btn-edit" (click)="cerrarModalEditar()" [disabled]="guardandoEdicion">
        &times;
      </button>
    </div>

    <form *ngIf="cargaEditando" (ngSubmit)="guardarEdicion()" #editForm="ngForm">
      
      <div class="modal-body-edit">
        
        <div *ngIf="cargandoEdicion" class="loader-container-edit">
          <p>Cargando datos de la carga...</p>
        </div>

        <div *ngIf="!cargandoEdicion">
          <div class="form-group-edit">
            <label for="editEconomico">Autob√∫s:</label>
            <input type="text" id="editEconomico" [value]="cargaEditando.economico" class="form-control-edit" readonly disabled>
          </div>

          <div class="form-group-edit">
            <label for="editFecha">Fecha y Hora de Operaci√≥n:</label>
            <input type="datetime-local" id="editFecha" class="form-control-edit"
                   [(ngModel)]="formEdicion.fecha_operacion" name="fecha_operacion"
                   [max]="fechaMaxima" required>
          </div>

          <div class="form-row-edit">
            <div class="form-group-edit half-width-edit">
              <label for="editKmInicial">KM Inicial:</label>
              <input type="number" id="editKmInicial" class="form-control-edit"
                     [(ngModel)]="formEdicion.km_inicial" name="km_inicial"
                     required min="0" step="any">
            </div>
            <div class="form-group-edit half-width-edit">
              <label for="editKmFinal">KM Final:</label>
              <input type="number" id="editKmFinal" class="form-control-edit"
                     [(ngModel)]="formEdicion.km_final" name="km_final"
                     required min="0" step="any">
            </div>
          </div>
          
          <div *ngIf="formEdicion.km_final > 0 && formEdicion.km_final <= formEdicion.km_inicial" class="text-danger-edit small-edit">
            El KM Final debe ser mayor al KM Inicial.
          </div>

          <div class="form-group-edit">
            <label for="editLitros">Litros Cargados:</label>
            <input type="number" id="editLitros" class="form-control-edit"
                   [(ngModel)]="formEdicion.litros_cargados" name="litros_cargados"
                   required min="0.01" step="0.01">
          </div>

          <div class="form-group-edit">
            <label for="editRuta">Ruta:</label>
            <select id="editRuta" class="form-control-edit"
                    [(ngModel)]="formEdicion.id_ruta" name="id_ruta">
              <option [ngValue]="null">-- C√°lculo por D√≠as / Sin Ruta --</option>
              <option *ngFor="let ruta of rutas" [value]="ruta.id_ruta">
                {{ ruta.nombre_ruta }}
              </option>
            </select>
            <small class="form-text-edit">Seleccione una ruta si esta carga debe calcularse por 'vueltas'. D√©jelo en blanco si es por 'd√≠as'.</small>
          </div>
        </div> </div> <div class="modal-footer-edit">
        <button type="button" class="btn-edit btn-secondary-edit" (click)="cerrarModalEditar()" [disabled]="guardandoEdicion">
          Cancelar
        </button>
        
        <button type="submit" class="btn-edit btn-primary-edit"
                [disabled]="!editForm.form.valid || guardandoEdicion || (formEdicion.km_final <= formEdicion.km_inicial)">
          <span *ngIf="!guardandoEdicion">Guardar y Recalcular</span>
          <span *ngIf="guardandoEdicion">Guardando...</span>
        </button>
      </div>

    </form> </div> </div>
    <div *ngIf="modalEditarVisible && esSuperUsuario()" 
     class="modal-backdrop-edit" 
     (click)="cerrarModalEditar()">
  
  <!-- Contenedor del Modal -->
  <div class="modal-content-edit" (click)="$event.stopPropagation()">
    
    <!-- Header del Modal -->
    <div class="modal-header-edit">
      <div class="modal-title-container">
        <svg xmlns="http://www.w3.org/2000/svg" class="modal-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
        </svg>
        <h3>Editar Carga de Combustible</h3>
      </div>
      <button class="modal-close-btn-edit" 
              (click)="cerrarModalEditar()" 
              [disabled]="guardandoEdicion"
              title="Cerrar">
        &times;
      </button>
    </div>

    <!-- Body del Modal -->
    <form *ngIf="cargaEditando" (ngSubmit)="guardarEdicion()" #editForm="ngForm">
      
      <div class="modal-body-edit">
        
        <!-- Loader mientras carga datos -->
        <div *ngIf="cargandoEdicion" class="loader-container-edit">
          <div class="spinner-edit"></div>
          <p>Cargando datos de la carga...</p>
        </div>

        <!-- Formulario de edici√≥n -->
        <div *ngIf="!cargandoEdicion">
          
          <!-- Informaci√≥n del registro (solo lectura) -->
          <div class="info-section-edit">
            <h4>üìã Informaci√≥n del Registro</h4>
            <div class="info-grid-edit">
              <div class="info-item-edit">
                <span class="info-label-edit">ID Carga:</span>
                <span class="info-value-edit">#{{ cargaEditando.id_carga }}</span>
              </div>
              <div class="info-item-edit">
                <span class="info-label-edit">Autob√∫s:</span>
                <span class="info-value-edit">{{ cargaEditando.economico || '-' }}</span>
              </div>
              <div class="info-item-edit">
                <span class="info-label-edit">Operador:</span>
                <span class="info-value-edit">{{ cargaEditando.nombre_operador || cargaEditando.nombre_completo || '-' }}</span>
              </div>
            </div>
          </div>

          <!-- Fecha de Operaci√≥n -->
          <div class="form-group-edit">
            <label for="editFecha" class="required-label-edit">
              üìÖ Fecha y Hora de Operaci√≥n
            </label>
            <input type="datetime-local" 
                   id="editFecha" 
                   class="form-control-edit"
                   [(ngModel)]="formEdicion.fecha_operacion" 
                   name="fecha_operacion"
                   [max]="fechaMaxima" 
                   required>
            <small class="form-hint-edit">Fecha en la que se realiz√≥ la operaci√≥n</small>
          </div>

          <!-- Kilometrajes -->
          <div class="form-row-edit">
            <div class="form-group-edit half-width-edit">
              <label for="editKmInicial" class="required-label-edit">
                üî¢ KM Inicial
              </label>
              <input type="number" 
                     id="editKmInicial" 
                     class="form-control-edit"
                     [(ngModel)]="formEdicion.km_inicial" 
                     name="km_inicial"
                     required 
                     min="0" 
                     step="1"
                     placeholder="Ej: 15000">
              <small class="form-hint-edit">Kilometraje inicial del autob√∫s</small>
            </div>
            
            <div class="form-group-edit half-width-edit">
              <label for="editKmFinal" class="required-label-edit">
                üî¢ KM Final
              </label>
              <input type="number" 
                     id="editKmFinal" 
                     class="form-control-edit"
                     [(ngModel)]="formEdicion.km_final" 
                     name="km_final"
                     required 
                     min="0" 
                     step="1"
                     placeholder="Ej: 15250">
              <small class="form-hint-edit">Kilometraje final del autob√∫s</small>
            </div>
          </div>
          
          <!-- Alerta si KM Final <= KM Inicial -->
          <div *ngIf="formEdicion.km_final > 0 && formEdicion.km_final <= formEdicion.km_inicial" 
               class="alert-danger-edit">
            ‚ö†Ô∏è El KM Final debe ser mayor al KM Inicial
          </div>

          <!-- KM Recorridos (calculado en tiempo real) -->
          <div class="calculated-box-edit calculated-blue">
            <div class="calculated-label-edit">üìè KM Recorridos:</div>
            <div class="calculated-value-edit">{{ calcularKmRecorridos() | number:'1.0-0' }} km</div>
          </div>

          <!-- Litros Cargados -->
          <div class="form-group-edit">
            <label for="editLitros" class="required-label-edit">
              ‚õΩ Litros Cargados
            </label>
            <input type="number" 
                   id="editLitros" 
                   class="form-control-edit"
                   [(ngModel)]="formEdicion.litros_cargados" 
                   name="litros_cargados"
                   required 
                   min="0.01" 
                   step="0.01"
                   placeholder="Ej: 85.50">
            <small class="form-hint-edit">Cantidad de litros de combustible cargados</small>
          </div>

          <!-- Rendimiento Estimado (calculado en tiempo real) -->
          <div class="calculated-box-edit calculated-green">
            <div class="calculated-label-edit">üìä Rendimiento Estimado:</div>
            <div class="calculated-value-edit">{{ calcularRendimientoEstimado() | number:'1.2-2' }} km/L</div>
          </div>

          <!-- Ruta -->
          <div class="form-group-edit">
            <label for="editRuta">
              üõ£Ô∏è Ruta
            </label>
            <select id="editRuta" 
                    class="form-control-edit"
                    [(ngModel)]="formEdicion.id_ruta" 
                    name="id_ruta">
              <option [ngValue]="null">-- C√°lculo por D√≠as / Sin Ruta --</option>
              <option *ngFor="let ruta of rutas" [value]="ruta.id_ruta">
                {{ ruta.nombre_ruta }}
              </option>
            </select>
            <small class="form-hint-edit">
              Seleccione una ruta si esta carga debe calcularse por 'vueltas'. 
              D√©jelo en blanco si es por 'd√≠as'.
            </small>
          </div>

          <!-- Resumen de Cambios -->
          <div *ngIf="detectarCambios()" class="changes-summary-edit">
            <h4>‚ö†Ô∏è Cambios Detectados</h4>
            <ul class="changes-list-edit">
              <li *ngFor="let cambio of obtenerResumenCambios()">
                <svg xmlns="http://www.w3.org/2000/svg" class="change-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
                {{ cambio }}
              </li>
            </ul>
            <div class="recalc-notice-edit">
              <svg xmlns="http://www.w3.org/2000/svg" class="notice-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <strong>Se recalcular√°n autom√°ticamente:</strong> KM Recorridos, Rendimiento, Desviaci√≥n y Clasificaci√≥n
            </div>
          </div>

          <!-- Mensaje si no hay cambios -->
          <div *ngIf="!detectarCambios() && !cargandoEdicion" class="no-changes-edit">
            ‚ÑπÔ∏è No se han realizado cambios en los datos
          </div>

        </div>
      </div>

      <!-- Footer del Modal -->
      <div class="modal-footer-edit">
        <button type="button" 
                class="btn-edit btn-secondary-edit" 
                (click)="cerrarModalEditar()" 
                [disabled]="guardandoEdicion">
          <svg xmlns="http://www.w3.org/2000/svg" class="btn-icon-edit" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          Cancelar
        </button>
        
        <button type="submit" 
                class="btn-edit btn-primary-edit"
                [disabled]="!editForm.form.valid || guardandoEdicion || (formEdicion.km_final <= formEdicion.km_inicial) || !detectarCambios()">
          <svg *ngIf="!guardandoEdicion" xmlns="http://www.w3.org/2000/svg" class="btn-icon-edit" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          <div *ngIf="guardandoEdicion" class="spinner-small-edit"></div>
          <span>{{ guardandoEdicion ? 'Guardando...' : 'Guardar y Recalcular' }}</span>
        </button>
      </div>

    </form>

  </div>
</div>