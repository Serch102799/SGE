<div class="usuarios-container">
  <div class="container-header">
    <h2>Historial de Cargas de Combustible</h2>
    <div class="acciones-header">
      <button 
        class="btn-exportar btn-exportar-excel" 
        (click)="exportarAExcel()"
        [disabled]="exportandoExcel || cargas.length === 0"
        title="Descargar datos en formato Excel">
        <span *ngIf="!exportandoExcel">üìä Exportar a Excel</span>
        <span *ngIf="exportandoExcel">‚è≥ Generando Excel...</span>
      </button>
      <button 
        class="btn-exportar btn-exportar-pdf" 
        (click)="exportarAPDF()"
        [disabled]="exportando || cargas.length === 0"
        title="Descargar datos en formato PDF">
        <span *ngIf="!exportando">üìÑ Exportar a PDF</span>
        <span *ngIf="exportando">‚è≥ Generando PDF...</span>
      </button>
      <a routerLink="/admin/registro-carga-combustible" class="btn-agregar">
        <span>&#43;</span> Registrar Nueva Carga
      </a>
    </div>
  </div>

  <div class="container-body">
    <!-- NUEVO: Selector de Tipo de C√°lculo -->
    <div class="tipo-calculo-selector">
      <div class="selector-label">Filtrar por tipo de c√°lculo:</div>
      <div class="selector-buttons">
        <button 
          (click)="cambiarTipoCalculo('vueltas')"
          [class.active]="tipoCalculo === 'vueltas'"
          class="btn-tipo-calculo">
          üìç Por Vueltas
        </button>
        <button 
          (click)="cambiarTipoCalculo('dias')"
          [class.active]="tipoCalculo === 'dias'"
          class="btn-tipo-calculo">
          üìÖ Por D√≠as
        </button>
      </div>
    </div>

    <div class="filtros-container">
      <div class="filtro-item">
        <input 
          type="text" 
          class="form-control" 
          placeholder="Buscar por econ√≥mico u operador..."
          [(ngModel)]="terminoBusqueda" 
          (ngModelChange)="onSearchChange()">
      </div>
      <div class="filtro-item">
        <select 
          class="form-control" 
          [(ngModel)]="filtroRutaId" 
          (change)="onRutaChange()"
          [disabled]="tipoCalculo === 'dias'">
          <option value="">Todas las Rutas</option>
          <option *ngFor="let ruta of rutas" [value]="ruta.id_ruta">
            {{ ruta.nombre_ruta }}
          </option>
        </select>
        <small *ngIf="tipoCalculo === 'dias'" class="hint-text">
          El filtro por ruta no est√° disponible en c√°lculo por d√≠as
        </small>
      </div>
    </div>

    <div class="contador-resultados">
      <strong>{{ totalItems }}</strong> cargas encontradas
      <span class="tipo-calculo-badge">{{ tipoCalculo === 'vueltas' ? '(Por Vueltas)' : '(Por D√≠as)' }}</span>
    </div>

    <div class="tabla-responsive-wrapper">
      <table class="tabla-usuarios">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Autob√∫s</th>
            <th>Operador</th>
            <th>KM Inicial</th> 
            <th>KM Final</th>
            <th>KM Recorridos</th>
            <th>Litros</th>
            <th>Rendimiento (KM/L)</th>
            <!-- CAMBIO: Columna condicional seg√∫n tipo_calculo -->
            <th *ngIf="tipoCalculo === 'vueltas'">Rutas y Vueltas</th>
            <th *ngIf="tipoCalculo === 'dias'">Ruta Principal</th>
            <th>Despachador</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let carga of cargas | paginate: { itemsPerPage: itemsPerPage, currentPage: currentPage, totalItems: totalItems }">
            <td>{{ carga.fecha_operacion | date:'dd/MM/yy h:mm a' }}</td>
            <td>{{ carga.economico }}</td>
            <td>{{ carga.nombre_operador }}</td>
            <td>{{ carga.km_inicial | number }} km</td> 
            <td>{{ carga.km_final | number }} km</td>
            <td>{{ carga.km_recorridos | number }} km</td>
            <td>{{ carga.litros_cargados | number:'1.2-2' }} Lts</td>
            <td>
              <span [ngClass]="{'alerta-rendimiento': carga.alerta_rendimiento}">
                {{ carga.rendimiento_calculado | number:'1.2-2' }}
              </span>
            </td>
            <!-- CAMBIO: Mostrar diferentes datos seg√∫n tipo_calculo -->
            <td *ngIf="tipoCalculo === 'vueltas'">
              {{ carga.rutas_y_vueltas || '-' }}
            </td>
            <td *ngIf="tipoCalculo === 'dias'">
              {{ carga.rutas_y_vueltas || '-' }}
            </td>
            <td>{{ carga.nombre_despachador }}</td>
          </tr>
          <tr *ngIf="cargas.length === 0">
            <td [attr.colspan]="tipoCalculo === 'vueltas' ? 9 : 9" class="empty-table-message">
              No se encontraron cargas que coincidan con los filtros.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination-controls">
      <pagination-controls 
        (pageChange)="onPageChange($event)" 
        previousLabel="Anterior" 
        nextLabel="Siguiente">
      </pagination-controls>
    </div>
  </div>
</div>